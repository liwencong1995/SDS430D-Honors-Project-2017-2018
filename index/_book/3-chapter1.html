<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Honors Project Paper</title>
  <meta name="description" content="Honors Project Paper">
  <meta name="generator" content="bookdown 0.5.10 and GitBook 2.6.7">

  <meta property="og:title" content="Honors Project Paper" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Honors Project Paper" />
  
  
  

<meta name="author" content="Wencong (Priscilla) Li">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="2-introduction.html">
<link rel="next" href="4-chapter2.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"></a></li>
<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Delete line 6 if you only have one advisor</a></li>
<li class="chapter" data-level="2" data-path="2-introduction.html"><a href="2-introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="2-introduction.html"><a href="2-introduction.html#motivation"><i class="fa fa-check"></i><b>2.1</b> Motivation</a></li>
<li class="chapter" data-level="2.2" data-path="2-introduction.html"><a href="2-introduction.html#background"><i class="fa fa-check"></i><b>2.2</b> Background</a><ul>
<li class="chapter" data-level="2.2.1" data-path="2-introduction.html"><a href="2-introduction.html#yellow-taxi"><i class="fa fa-check"></i><b>2.2.1</b> Yellow Taxi</a></li>
<li class="chapter" data-level="2.2.2" data-path="2-introduction.html"><a href="2-introduction.html#green-taxi"><i class="fa fa-check"></i><b>2.2.2</b> Green Taxi</a></li>
<li class="chapter" data-level="2.2.3" data-path="2-introduction.html"><a href="2-introduction.html#uber"><i class="fa fa-check"></i><b>2.2.3</b> Uber</a></li>
<li class="chapter" data-level="2.2.4" data-path="2-introduction.html"><a href="2-introduction.html#lyft"><i class="fa fa-check"></i><b>2.2.4</b> Lyft</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="2-introduction.html"><a href="2-introduction.html#literature-review"><i class="fa fa-check"></i><b>2.3</b> Literature Review</a><ul>
<li class="chapter" data-level="2.3.1" data-path="2-introduction.html"><a href="2-introduction.html#yellow-taxi-1"><i class="fa fa-check"></i><b>2.3.1</b> Yellow Taxi</a></li>
<li class="chapter" data-level="2.3.2" data-path="2-introduction.html"><a href="2-introduction.html#green-taxi-1"><i class="fa fa-check"></i><b>2.3.2</b> Green Taxi</a></li>
<li class="chapter" data-level="2.3.3" data-path="2-introduction.html"><a href="2-introduction.html#uber-1"><i class="fa fa-check"></i><b>2.3.3</b> Uber</a></li>
<li class="chapter" data-level="2.3.4" data-path="2-introduction.html"><a href="2-introduction.html#lyft-1"><i class="fa fa-check"></i><b>2.3.4</b> Lyft</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="2-introduction.html"><a href="2-introduction.html#contribution"><i class="fa fa-check"></i><b>2.4</b> Contribution</a><ul>
<li class="chapter" data-level="2.4.1" data-path="2-introduction.html"><a href="2-introduction.html#nyctaxi-package"><i class="fa fa-check"></i><b>2.4.1</b> nyctaxi Package</a></li>
<li class="chapter" data-level="2.4.2" data-path="2-introduction.html"><a href="2-introduction.html#social-impact-of-nyc-taxi"><i class="fa fa-check"></i><b>2.4.2</b> Social Impact of NYC Taxi</a></li>
<li class="chapter" data-level="2.4.3" data-path="2-introduction.html"><a href="2-introduction.html#modeling-of-nyc-taxi-fare"><i class="fa fa-check"></i><b>2.4.3</b> Modeling of NYC Taxi Fare</a></li>
<li class="chapter" data-level="2.4.4" data-path="2-introduction.html"><a href="2-introduction.html#reproducible-research"><i class="fa fa-check"></i><b>2.4.4</b> Reproducible Research</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="3-chapter1.html"><a href="3-chapter1.html"><i class="fa fa-check"></i><b>3</b> Data and nyctaxi Package</a><ul>
<li class="chapter" data-level="3.1" data-path="3-chapter1.html"><a href="3-chapter1.html#data-and-storage"><i class="fa fa-check"></i><b>3.1</b> Data and Storage</a><ul>
<li class="chapter" data-level="3.1.1" data-path="3-chapter1.html"><a href="3-chapter1.html#yellow-taxi-2"><i class="fa fa-check"></i><b>3.1.1</b> Yellow Taxi</a></li>
<li class="chapter" data-level="3.1.2" data-path="3-chapter1.html"><a href="3-chapter1.html#green-taxi-2"><i class="fa fa-check"></i><b>3.1.2</b> Green Taxi</a></li>
<li class="chapter" data-level="3.1.3" data-path="3-chapter1.html"><a href="3-chapter1.html#uber-2"><i class="fa fa-check"></i><b>3.1.3</b> Uber</a></li>
<li class="chapter" data-level="3.1.4" data-path="3-chapter1.html"><a href="3-chapter1.html#lyft-2"><i class="fa fa-check"></i><b>3.1.4</b> Lyft</a></li>
<li class="chapter" data-level="3.1.5" data-path="3-chapter1.html"><a href="3-chapter1.html#storage"><i class="fa fa-check"></i><b>3.1.5</b> Storage</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="3-chapter1.html"><a href="3-chapter1.html#etl-nyctaxi-package"><i class="fa fa-check"></i><b>3.2</b> ETL nyctaxi Package</a></li>
<li class="chapter" data-level="3.3" data-path="3-chapter1.html"><a href="3-chapter1.html#extract"><i class="fa fa-check"></i><b>3.3</b> Extract</a><ul>
<li class="chapter" data-level="3.3.1" data-path="3-chapter1.html"><a href="3-chapter1.html#yellow-taxi-3"><i class="fa fa-check"></i><b>3.3.1</b> Yellow Taxi</a></li>
<li class="chapter" data-level="3.3.2" data-path="3-chapter1.html"><a href="3-chapter1.html#green-taxi-3"><i class="fa fa-check"></i><b>3.3.2</b> Green Taxi</a></li>
<li class="chapter" data-level="3.3.3" data-path="3-chapter1.html"><a href="3-chapter1.html#uber-3"><i class="fa fa-check"></i><b>3.3.3</b> Uber</a></li>
<li class="chapter" data-level="3.3.4" data-path="3-chapter1.html"><a href="3-chapter1.html#lyft-3"><i class="fa fa-check"></i><b>3.3.4</b> Lyft</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="3-chapter1.html"><a href="3-chapter1.html#transform"><i class="fa fa-check"></i><b>3.4</b> Transform</a><ul>
<li class="chapter" data-level="3.4.1" data-path="3-chapter1.html"><a href="3-chapter1.html#yellow-taxi-4"><i class="fa fa-check"></i><b>3.4.1</b> Yellow Taxi</a></li>
<li class="chapter" data-level="3.4.2" data-path="3-chapter1.html"><a href="3-chapter1.html#green-taxi-4"><i class="fa fa-check"></i><b>3.4.2</b> Green Taxi</a></li>
<li class="chapter" data-level="3.4.3" data-path="3-chapter1.html"><a href="3-chapter1.html#uber-4"><i class="fa fa-check"></i><b>3.4.3</b> Uber</a></li>
<li class="chapter" data-level="3.4.4" data-path="3-chapter1.html"><a href="3-chapter1.html#lyft-4"><i class="fa fa-check"></i><b>3.4.4</b> Lyft</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="3-chapter1.html"><a href="3-chapter1.html#load"><i class="fa fa-check"></i><b>3.5</b> Load</a><ul>
<li class="chapter" data-level="3.5.1" data-path="3-chapter1.html"><a href="3-chapter1.html#yellow-taxi-5"><i class="fa fa-check"></i><b>3.5.1</b> Yellow Taxi</a></li>
<li class="chapter" data-level="3.5.2" data-path="3-chapter1.html"><a href="3-chapter1.html#green-taxi-5"><i class="fa fa-check"></i><b>3.5.2</b> Green Taxi</a></li>
<li class="chapter" data-level="3.5.3" data-path="3-chapter1.html"><a href="3-chapter1.html#uber-5"><i class="fa fa-check"></i><b>3.5.3</b> Uber</a></li>
<li class="chapter" data-level="3.5.4" data-path="3-chapter1.html"><a href="3-chapter1.html#lyft-5"><i class="fa fa-check"></i><b>3.5.4</b> Lyft</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="3-chapter1.html"><a href="3-chapter1.html#sql-database-initialization"><i class="fa fa-check"></i><b>3.6</b> SQL Database Initialization</a><ul>
<li class="chapter" data-level="3.6.1" data-path="3-chapter1.html"><a href="3-chapter1.html#yellow-taxi-6"><i class="fa fa-check"></i><b>3.6.1</b> Yellow Taxi</a></li>
<li class="chapter" data-level="3.6.2" data-path="3-chapter1.html"><a href="3-chapter1.html#green-taxi-6"><i class="fa fa-check"></i><b>3.6.2</b> Green Taxi</a></li>
<li class="chapter" data-level="3.6.3" data-path="3-chapter1.html"><a href="3-chapter1.html#uber-6"><i class="fa fa-check"></i><b>3.6.3</b> Uber</a></li>
<li class="chapter" data-level="3.6.4" data-path="3-chapter1.html"><a href="3-chapter1.html#lyft-6"><i class="fa fa-check"></i><b>3.6.4</b> Lyft</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="3-chapter1.html"><a href="3-chapter1.html#source-code"><i class="fa fa-check"></i><b>3.7</b> Source Code</a><ul>
<li class="chapter" data-level="3.7.1" data-path="3-chapter1.html"><a href="3-chapter1.html#etl-extract"><i class="fa fa-check"></i><b>3.7.1</b> ETL Extract</a></li>
<li class="chapter" data-level="3.7.2" data-path="3-chapter1.html"><a href="3-chapter1.html#etl-transform"><i class="fa fa-check"></i><b>3.7.2</b> ETL Transform</a></li>
<li class="chapter" data-level="3.7.3" data-path="3-chapter1.html"><a href="3-chapter1.html#etl-load"><i class="fa fa-check"></i><b>3.7.3</b> ETL Load</a></li>
<li class="chapter" data-level="3.7.4" data-path="3-chapter1.html"><a href="3-chapter1.html#utils"><i class="fa fa-check"></i><b>3.7.4</b> utils</a></li>
<li class="chapter" data-level="3.7.5" data-path="3-chapter1.html"><a href="3-chapter1.html#etl-init"><i class="fa fa-check"></i><b>3.7.5</b> ETL Init</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="4-chapter2.html"><a href="4-chapter2.html"><i class="fa fa-check"></i><b>4</b> Using New York City Yellow Taxi Data to Answer Real Life Problems</a><ul>
<li class="chapter" data-level="4.1" data-path="4-chapter2.html"><a href="4-chapter2.html#new-york-city-taxi-fare-pricing-model"><i class="fa fa-check"></i><b>4.1</b> New York City Taxi Fare Pricing Model</a></li>
<li class="chapter" data-level="4.2" data-path="4-chapter2.html"><a href="4-chapter2.html#transportation-network-in-new-york-city"><i class="fa fa-check"></i><b>4.2</b> Transportation Network in New York City</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i>Conclusion</a></li>
<li class="chapter" data-level="5" data-path="5-the-first-appendix.html"><a href="5-the-first-appendix.html"><i class="fa fa-check"></i><b>5</b> The First Appendix</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Honors Project Paper</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="chapter1" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Data and nyctaxi Package</h1>
<div id="data-and-storage" class="section level2">
<h2><span class="header-section-number">3.1</span> Data and Storage</h2>
<div id="yellow-taxi-2" class="section level3">
<h3><span class="header-section-number">3.1.1</span> Yellow Taxi</h3>
<p>The total size of all yellow taxi trip data CSV files (from Jan 2010 to Dec 2016) is 191.38 GB, and NYC yellow taxi trip data from Jan 2009 to the most recent month can be found on NYC Taxi &amp; Limousine Commission (TLC). The data were collected and provided to the NYC TLC by technology providers authorized under the Taxicab &amp; Livery Passenger Enhancement Programs (TPEP/LPEP).</p>
<p>The yellow taxi trip records include the following fields: pick-up and drop-off dates/times, pick-up and drop-off locations, trip distances, itemized fares, rate types, payment types, and driver-reported passenger counts.</p>
</div>
<div id="green-taxi-2" class="section level3">
<h3><span class="header-section-number">3.1.2</span> Green Taxi</h3>
<p>The total size of green taxi trip data CSV files (from Aug 2013 to Dec 2016) is 7.8 GB, and green taxi trip data from Aug 2013 to the most recent month can be downloaded from NYC Taxi &amp; Limousine Commission (TLC). The data were collected and provided to the NYC TLC by technology providers authorized under the Taxicab &amp; Livery Passenger Enhancement Programs (TPEP/LPEP).</p>
<p>The green taxi trip records include the following fields: pick-up and drop-off dates/times, pick-up and drop-off locations, trip distances, itemized fares, rate types, payment types, and driver-reported passenger counts.</p>
</div>
<div id="uber-2" class="section level3">
<h3><span class="header-section-number">3.1.3</span> Uber</h3>
<p>The total size of Uber pick-up data (over 4.5 million from Apr to Sep 2014 and 14.3 million from Jan to June 2015) is 4.3 MB, and thanks to FiveThirtyEight who obtained the data from NYC TLC by submitting a Freedom of Information Law request on July 20, 2015, these data are now open to public.</p>
<p>The 2014 Uber data contains four variables: Data/Time (the date and time of the Uber pick-up), Lat (the latitude of the Uber pick-up), Lon (the longitude of the Uber pick-up), and Base (the TLC base company code affiliated with the Uber pickup).</p>
<p>The 2015 Uber data contains four variables: Dispatching_base_num (the TLC base company code of the base that dispatched the Uber), Pickup_date (the date of the Uber pick-up), Affiliated_base_num (the TLC base company code affiliated with the Uber pickup), and locationID (the pick-up location ID affiliated with the Uber pickup).</p>
</div>
<div id="lyft-2" class="section level3">
<h3><span class="header-section-number">3.1.4</span> Lyft</h3>
<p>The total size of weely-aggregated Lyft trip data (from Jan 2015 to Dec 2016) is 914.9 MB, and these data are open to public and weekly-aggregated Lyft data from 2015 to the most recent week can be found on NYC OpenData website.</p>
</div>
<div id="storage" class="section level3">
<h3><span class="header-section-number">3.1.5</span> Storage</h3>
<p>The total size of all CSV files of the four services is about 200 GB, and a laptop usually has memory less than or equal to 8GB. Limited memory constrains the amount of data that can be loaded by a personal computer. When users load data into R environment, R keeps them in memory; when the amount of data loaded into R environment gets close to the limit of a computerâ€™s memory, R becomes unresponsive or force quit the current session. Therefore, better ways to work with data that takes more space than 8 GB is needed. According to Weijia Zhang (2016), comparing to RAM, hard disk is often used to store medium-sized data, because it is affordable and are designed for storing large items permanently. However, retrieving data from hard drives usually takes about 1,000,000 times more time.</p>
</div>
</div>
<div id="etl-nyctaxi-package" class="section level2">
<h2><span class="header-section-number">3.2</span> ETL nyctaxi Package</h2>
<p>etl is the parent package of nyctaxi. etl package provides a CRAN-friendly framework that allows R users to work with medium data without any knowledge in SQL database. The end result is a populated SQL database, but the user interaction takes place solely within R. It has three operations -extract, transfer, and load- which bring real-time data into local or remote databases. etl-dependent packages make medium data - too big to store in memory on a laptop- more accessible to a wider audience. Additionally, etl-dependent packages use SQL translation supported by dyplr.</p>
<p>nyctaxi was initially designed to work with New York City taxi data, but later on Uber and Lyft data were added and the ETL functions are modified to be specialized in working with these data. This package compiled three major sources of hail service in New York City so that it is convenient for users to compare and contrast the performance of these three services.</p>
<p>This package inherits functions from many packages: etl, dplyr, DBI, rlang, and stringr. Since SQL databases are good tools for medium data analysis, ETL functions build connection to a SQL database at the back end and convert R code automatically into SQL queries and send them to the SQL database to get data tables containing data of each hail service. Thus, users do not need to have any knowledge of SQL queries and they can draw in any subsets of the data from the SQL database in R.</p>
<p>In general, extract.nyctaxi function download data of the four types of hail service data (yellow taxi, green taxi, uber, and lyft) from the corresponding sources. transform.nyctaxi uses different techniques to clean all four types of data to get then ready for the next step. extract.load loads the data user selected to a SQL database.</p>
<p>nyctaxi lives on the Comprehensive R Archive Network (CRAN), and Packages can be installed with the install.packages() function in R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#install the package</span>
<span class="kw">install.packages</span>(<span class="st">&quot;nyctaxi&quot;</span>)

<span class="co"># load the package</span>
<span class="kw">library</span>(nyctaxi)</code></pre></div>
<p>Users need to create an etl object in order to apply the etl operations to it, and only the name of the SQL database, working directory, and type of SQL database need to be specified during initialization. If the type of SQL database is not specified, a local RSQLite database will be generated as default.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># initializing an etl object</span>
db &lt;-<span class="st"> </span><span class="kw">src_mysql</span>(<span class="st">&quot;nyctaxi&quot;</span>, <span class="dt">user =</span> <span class="st">&quot;urname&quot;</span>, <span class="dt">host =</span> <span class="st">&quot;host&quot;</span>, <span class="dt">password =</span> <span class="st">&quot;pw&quot;</span>)
taxi &lt;-<span class="st"> </span><span class="kw">etl</span>(<span class="st">&quot;nyctaxi&quot;</span>, <span class="dt">dir =</span> <span class="st">&quot;~/Desktop/nyctaxi&quot;</span>, db)</code></pre></div>
<p>In the example above, a folder called nyctaxi is created on the desktop and a connection to a MySQL database is generated. In the procession of initialization, a local folder contains two subfolders, <code>raw</code> and <code>load</code>, are also created under the directory the user specifies. <code>raw</code> folder stores data downloaded from online open sources, and <code>load</code> folder stores cleaned CSV data files that are ready to be loaded into SQL database. The ETL framework keeps data directly scraped from online data sources in their original forms. In this way, the original data is always available to users in case data corruption happens in later stages.</p>
<p>After an etl object is created (nyctaxi is the etl object in this case), four parameters are needed to specify the data that users want: (1) obj: an etl object (2) years: a numeric vector giving the years. The default is the most recent year. (3) months: a numeric vector giving the months. The default is January to December. (4) type: a character variable giving the type of data the user wants to download. There are four types: yellow, green, uber, and lyft. The default is yellow.</p>
</div>
<div id="extract" class="section level2">
<h2><span class="header-section-number">3.3</span> Extract</h2>
<p>etl_extract.nyctaxi allows users to download New York City yellow taxi, green taxi, Uber, and Lyft data that are specific to their month of interest.</p>
<div id="yellow-taxi-3" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Yellow Taxi</h3>
</div>
<div id="green-taxi-3" class="section level3">
<h3><span class="header-section-number">3.3.2</span> Green Taxi</h3>
</div>
<div id="uber-3" class="section level3">
<h3><span class="header-section-number">3.3.3</span> Uber</h3>
</div>
<div id="lyft-3" class="section level3">
<h3><span class="header-section-number">3.3.4</span> Lyft</h3>
</div>
</div>
<div id="transform" class="section level2">
<h2><span class="header-section-number">3.4</span> Transform</h2>
<p>etl_extract.nyctaxi allows users to transform New York City yellow taxi, green taxi, Uber, and Lyft data into forms that are meaningful to users.</p>
<div id="yellow-taxi-4" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Yellow Taxi</h3>
</div>
<div id="green-taxi-4" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Green Taxi</h3>
</div>
<div id="uber-4" class="section level3">
<h3><span class="header-section-number">3.4.3</span> Uber</h3>
</div>
<div id="lyft-4" class="section level3">
<h3><span class="header-section-number">3.4.4</span> Lyft</h3>
</div>
</div>
<div id="load" class="section level2">
<h2><span class="header-section-number">3.5</span> Load</h2>
<p>etl_extract.nyctaxi allows users to load New York City yellow taxi, green taxi, Uber, and Lyft data into different data tables in a SQL database.</p>
<div id="yellow-taxi-5" class="section level3">
<h3><span class="header-section-number">3.5.1</span> Yellow Taxi</h3>
</div>
<div id="green-taxi-5" class="section level3">
<h3><span class="header-section-number">3.5.2</span> Green Taxi</h3>
</div>
<div id="uber-5" class="section level3">
<h3><span class="header-section-number">3.5.3</span> Uber</h3>
</div>
<div id="lyft-5" class="section level3">
<h3><span class="header-section-number">3.5.4</span> Lyft</h3>
</div>
</div>
<div id="sql-database-initialization" class="section level2">
<h2><span class="header-section-number">3.6</span> SQL Database Initialization</h2>
<div id="yellow-taxi-6" class="section level3">
<h3><span class="header-section-number">3.6.1</span> Yellow Taxi</h3>
</div>
<div id="green-taxi-6" class="section level3">
<h3><span class="header-section-number">3.6.2</span> Green Taxi</h3>
</div>
<div id="uber-6" class="section level3">
<h3><span class="header-section-number">3.6.3</span> Uber</h3>
</div>
<div id="lyft-6" class="section level3">
<h3><span class="header-section-number">3.6.4</span> Lyft</h3>
</div>
</div>
<div id="source-code" class="section level2">
<h2><span class="header-section-number">3.7</span> Source Code</h2>
<div id="etl-extract" class="section level3">
<h3><span class="header-section-number">3.7.1</span> ETL Extract</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">etl_extract.etl_nyctaxi &lt;-<span class="st"> </span><span class="cf">function</span>(obj, <span class="dt">years =</span> <span class="kw">as.numeric</span>(<span class="kw">format</span>(<span class="kw">Sys.Date</span>(),<span class="st">&#39;%Y&#39;</span>)), 
                                    <span class="dt">months =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, 
                                    <span class="dt">type  =</span> <span class="st">&quot;yellow&quot;</span>,...) {
  <span class="co">#TAXI YELLOW-----------------------------------------------------------------------</span>
  taxi_yellow &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months,...) {
    <span class="kw">message</span>(<span class="st">&quot;Extracting raw yellow taxi data...&quot;</span>)
    remote &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2009-01-01&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="st">&quot;https://s3.amazonaws.com/nyc-tlc/trip+data&quot;</span>, 
                               <span class="kw">paste0</span>(<span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;_tripdata_&quot;</span>, year, <span class="st">&quot;-&quot;</span>,
                                      stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>), <span class="st">&quot;.csv&quot;</span>))) 
    <span class="kw">tryCatch</span>(<span class="dt">expr =</span> etl<span class="op">::</span><span class="kw">smart_download</span>(obj, remote<span class="op">$</span>src, ...),
             <span class="dt">error =</span> <span class="cf">function</span>(e){<span class="kw">warning</span>(e)}, 
             <span class="dt">finally =</span> <span class="kw">warning</span>(<span class="st">&quot;Only the following data are availabel on TLC:</span>
<span class="st">                               Yellow taxi data: 2009 Jan - last month&quot;</span>))} 
  <span class="co">#TAXI GREEN-----------------------------------------------------------------------</span>
  taxi_green &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months,...) {
    <span class="kw">message</span>(<span class="st">&quot;Extracting raw green taxi data...&quot;</span>)
    remote &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2013-08-01&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="st">&quot;https://s3.amazonaws.com/nyc-tlc/trip+data&quot;</span>, 
                               <span class="kw">paste0</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;_tripdata_&quot;</span>, year, <span class="st">&quot;-&quot;</span>,
                                      stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>), <span class="st">&quot;.csv&quot;</span>)))
    <span class="kw">tryCatch</span>(<span class="dt">expr =</span> etl<span class="op">::</span><span class="kw">smart_download</span>(obj, remote<span class="op">$</span>src, ...),
             <span class="dt">error =</span> <span class="cf">function</span>(e){<span class="kw">warning</span>(e)}, 
             <span class="dt">finally =</span> <span class="kw">warning</span>(<span class="st">&quot;Only the following data are availabel on TLC:</span>
<span class="st">                               Green taxi data: 2013 Aug - last month&quot;</span>))} 
  <span class="co">#UBER-----------------------------------------------------------------------</span>
  uber &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months,...) {
    <span class="kw">message</span>(<span class="st">&quot;Extracting raw uber data...&quot;</span>)
    raw_month_<span class="dv">2014</span> &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(<span class="dt">years =</span> <span class="dv">2014</span>, <span class="dt">months =</span> <span class="dv">4</span><span class="op">:</span><span class="dv">9</span>)
    raw_month_<span class="dv">2015</span> &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(<span class="dt">years =</span> <span class="dv">2015</span>, <span class="dt">months =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>)
    raw_month &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(raw_month_<span class="dv">2014</span>, raw_month_<span class="dv">2015</span>)
    path =<span class="st"> &quot;https://raw.githubusercontent.com/fivethirtyeight/uber-tlc-foil-response/master/uber-trip-data&quot;</span>
    remote &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months)
    remote_small &lt;-<span class="st"> </span><span class="kw">intersect</span>(raw_month, remote)
    <span class="cf">if</span> (<span class="dv">2015</span> <span class="op">%in%</span><span class="st"> </span>remote_small<span class="op">$</span>year <span class="op">&amp;&amp;</span><span class="st"> </span><span class="op">!</span>(<span class="dv">2014</span> <span class="op">%in%</span><span class="st"> </span>remote_small<span class="op">$</span>year)){
      <span class="co">#download 2015 data</span>
      <span class="kw">message</span>(<span class="st">&quot;Downloading Uber 2015 data...&quot;</span>)
      etl<span class="op">::</span><span class="kw">smart_download</span>(obj, <span class="st">&quot;https://github.com/fivethirtyeight/uber-tlc-foil-response/raw/master/uber-trip-data/uber-raw-data-janjune-15.csv.zip&quot;</span>,...)}
    <span class="cf">else</span> <span class="cf">if</span> (<span class="dv">2015</span> <span class="op">%in%</span><span class="st"> </span>remote_small<span class="op">$</span>year <span class="op">&amp;&amp;</span><span class="st"> </span><span class="dv">2014</span> <span class="op">%in%</span><span class="st"> </span>remote_small<span class="op">$</span>year) {
      <span class="co">#download 2015 data</span>
      <span class="kw">message</span>(<span class="st">&quot;Downloading Uber 2015 data...&quot;</span>)
      etl<span class="op">::</span><span class="kw">smart_download</span>(obj, <span class="st">&quot;https://github.com/fivethirtyeight/uber-tlc-foil-response/raw/master/uber-trip-data/uber-raw-data-janjune-15.csv.zip&quot;</span>,...)
      <span class="co">#download 2014 data</span>
      small &lt;-<span class="st"> </span>remote_small <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">filter_</span>(<span class="op">~</span>year <span class="op">==</span><span class="st"> </span><span class="dv">2014</span>) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_</span>(<span class="dt">month_abb =</span> <span class="op">~</span><span class="kw">tolower</span>(month.abb[month]),
                <span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(path, <span class="kw">paste0</span>(<span class="st">&quot;uber-raw-data-&quot;</span>,month_abb,<span class="kw">substr</span>(year,<span class="dv">3</span>,<span class="dv">4</span>),<span class="st">&quot;.csv&quot;</span>)))
      <span class="kw">message</span>(<span class="st">&quot;Downloading Uber 2014 data...&quot;</span>)
      etl<span class="op">::</span><span class="kw">smart_download</span>(obj, small<span class="op">$</span>src,...) 
    } <span class="cf">else</span> <span class="cf">if</span> (<span class="dv">2014</span> <span class="op">%in%</span><span class="st"> </span>remote_small<span class="op">$</span>year <span class="op">&amp;&amp;</span><span class="st"> </span><span class="op">!</span>(<span class="dv">2015</span> <span class="op">%in%</span><span class="st"> </span>remote_small<span class="op">$</span>year)) {
      <span class="kw">message</span>(<span class="st">&quot;Downloading Uber 2014 data...&quot;</span>)
      <span class="co">#file paths</span>
      small &lt;-<span class="st"> </span>remote_small <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_</span>(<span class="dt">month_abb =</span> <span class="op">~</span><span class="kw">tolower</span>(month.abb[month]),
                <span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(path, <span class="kw">paste0</span>(<span class="st">&quot;uber-raw-data-&quot;</span>,month_abb,<span class="kw">substr</span>(year,<span class="dv">3</span>,<span class="dv">4</span>),<span class="st">&quot;.csv&quot;</span>)))
      etl<span class="op">::</span><span class="kw">smart_download</span>(obj, small<span class="op">$</span>src,...)}
    <span class="cf">else</span> {<span class="kw">warning</span>(<span class="st">&quot;The Uber data you requested are not currently available. Only data from 2014/04-2014/09 and 2015/01-2015/06 are available...&quot;</span>)}
    } 
  <span class="co">#LYFT-----------------------------------------------------------------------</span>
  lyft &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months,...){
    <span class="kw">message</span>(<span class="st">&quot;Extracting raw lyft data...&quot;</span>)
    <span class="co">#check if the week is valid</span>
    valid_months &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2015-01-01&quot;</span>)
    base_url =<span class="st"> &quot;https://data.cityofnewyork.us/resource/edp9-qgv4.csv&quot;</span>
    valid_months &lt;-<span class="st"> </span>valid_months <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">new_filenames =</span> <span class="op">~</span><span class="kw">paste0</span>(<span class="st">&quot;lyft-&quot;</span>, year, <span class="st">&quot;.csv&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">drop =</span> <span class="ot">TRUE</span>)
    <span class="co">#only keep one data set per year</span>
    year &lt;-<span class="st"> </span>valid_months[<span class="dv">1</span>,<span class="dv">1</span>]
    n &lt;-<span class="st"> </span><span class="kw">nrow</span>(valid_months)
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>n) {
      <span class="cf">if</span>(year <span class="op">==</span><span class="st"> </span>valid_months[i<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>]) {
        valid_months[i,<span class="dv">6</span>] &lt;-<span class="st"> </span><span class="ot">FALSE</span>
        year &lt;-<span class="st"> </span>valid_months[i<span class="op">+</span><span class="dv">1</span>,<span class="dv">1</span>]
      } <span class="cf">else</span> {
        valid_months[i,<span class="dv">6</span>] &lt;-<span class="st"> </span><span class="ot">TRUE</span>
        year &lt;-<span class="st"> </span>valid_months[i<span class="op">+</span><span class="dv">1</span>,<span class="dv">1</span>]}
      }
    row_to_keep =<span class="st"> </span>valid_months<span class="op">$</span>drop
    valid_months &lt;-<span class="st"> </span>valid_months[row_to_keep,]
    
    <span class="co">#download lyft files, try two different methods</span>
    first_try&lt;-<span class="kw">tryCatch</span>(
      <span class="kw">download_nyc_data</span>(obj, base_url, valid_months<span class="op">$</span>year, <span class="dt">n =</span> <span class="dv">50000</span>,
                        <span class="dt">names =</span> valid_months<span class="op">$</span>new_filenames),
      <span class="dt">error =</span> <span class="cf">function</span>(e){<span class="kw">warning</span>(e)},<span class="dt">finally =</span> <span class="st">&#39;method = &quot;libcurl&quot; fails&#39;</span>)
  }
  
  <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;yellow&quot;</span>){<span class="kw">taxi_yellow</span>(obj, years, months,...)} 
  <span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;green&quot;</span>){<span class="kw">taxi_green</span>(obj, years, months,...)}
  <span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;uber&quot;</span>){<span class="kw">uber</span>(obj, years, months,...)}
  <span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;lyft&quot;</span>){<span class="kw">lyft</span>(obj, years, months,...)}
  <span class="cf">else</span> {<span class="kw">message</span>(<span class="st">&quot;The type you chose does not exit...&quot;</span>)}
  
  <span class="kw">invisible</span>(obj)
}</code></pre></div>
</div>
<div id="etl-transform" class="section level3">
<h3><span class="header-section-number">3.7.2</span> ETL Transform</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">etl_transform.etl_nyctaxi &lt;-<span class="st"> </span><span class="cf">function</span>(obj, <span class="dt">years =</span> <span class="kw">as.numeric</span>(<span class="kw">format</span>(<span class="kw">Sys.Date</span>(),<span class="st">&#39;%Y&#39;</span>)), 
                                    <span class="dt">months =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, 
                                    <span class="dt">type  =</span> <span class="st">&quot;yellow&quot;</span>,...) {
  <span class="co">#TAXI YELLOW----------------------------------------------------------------</span>
  taxi_yellow &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months) {
    <span class="kw">message</span>(<span class="st">&quot;Transforming yellow taxi data from raw to load directory...&quot;</span>)
    <span class="co">#create a df of file path of the files that the user wants to transform</span>
    remote &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2009-01-01&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>), 
                               <span class="kw">paste0</span>(<span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;_tripdata_&quot;</span>, year, <span class="st">&quot;-&quot;</span>,
                                      stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>), <span class="st">&quot;.csv&quot;</span>))) 
    <span class="co">#create a df of file path of the files that are in the raw directory</span>
    src &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>), <span class="st">&quot;yellow&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
    src_small &lt;-<span class="st"> </span><span class="kw">intersect</span>(src, remote<span class="op">$</span>src)
    <span class="co">#Move the files</span>
    in_raw &lt;-<span class="st"> </span><span class="kw">basename</span>(src_small)
    in_load &lt;-<span class="st"> </span><span class="kw">basename</span>(<span class="kw">list.files</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), <span class="st">&quot;yellow&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>))
    file_remian &lt;-<span class="st"> </span><span class="kw">setdiff</span>(in_raw,in_load)
    <span class="kw">file.copy</span>(<span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>),file_remian),
              <span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>),file_remian) )}
  <span class="co">#TAXI GREEN----------------------------------------------------------------</span>
  taxi_green &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months) {
    <span class="kw">message</span>(<span class="st">&quot;Transforming green taxi data from raw to load directory...&quot;</span>)
    <span class="co">#create a df of file path of the files that the user wants to transform</span>
    remote &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2013-08-01&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>), <span class="kw">paste0</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;_tripdata_&quot;</span>, year, <span class="st">&quot;-&quot;</span>,
                                      stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>), <span class="st">&quot;.csv&quot;</span>))) 
    <span class="co">#create a df of file path of the files that are in the raw directory</span>
    src &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>), <span class="st">&quot;green&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
    src_small &lt;-<span class="st"> </span><span class="kw">intersect</span>(src, remote<span class="op">$</span>src)
    <span class="co">#Clean the green taxi data files</span>
    <span class="co">#get rid of 2nd blank row----------------------------------------------------------</span>
    <span class="cf">if</span> (<span class="kw">length</span>(src_small) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){
      <span class="kw">message</span>(<span class="st">&quot;The files you requested are not available in the raw directory.&quot;</span>)
    } <span class="cf">else</span>{
      <span class="co">#a list of the ones that have a 2nd blank row</span>
      remote_green_<span class="dv">1</span> &lt;-<span class="st"> </span>remote <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter_</span>(<span class="op">~</span>year <span class="op">!=</span><span class="st"> </span><span class="dv">2015</span>)
      src_small_green_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">intersect</span>(src, remote_green_<span class="dv">1</span><span class="op">$</span>src)
      <span class="co"># check that the sys support command line, and then remove the blank 2nd row</span>
      <span class="cf">if</span>(<span class="kw">length</span>(src_small_green_<span class="dv">1</span>) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {
        <span class="cf">if</span> (.Platform<span class="op">$</span>OS.type <span class="op">==</span><span class="st"> &quot;unix&quot;</span>){
          cmds_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;sed -i -e &#39;2d&#39;&quot;</span>, src_small_green_<span class="dv">1</span>)
          <span class="kw">lapply</span>(cmds_<span class="dv">1</span>, system)
        } <span class="cf">else</span> {
          <span class="kw">message</span>(<span class="st">&quot;Windows system does not currently support removing the 2nd blank row </span>
<span class="st">                  in the green taxi datasets. This might affect loading data into SQL...&quot;</span>)}
        }<span class="cf">else</span> {
          <span class="st">&quot;You did not request for any green taxi data, or all the green taxi data you requested are cleaned.&quot;</span>}
      <span class="co">#fix column number---------------------------------------------------------------</span>
      remote_green_<span class="dv">2</span> &lt;-<span class="st"> </span>remote <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">filter_</span>(<span class="op">~</span>year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2013</span>, <span class="dv">2014</span>, <span class="dv">2015</span>)) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_</span>(<span class="dt">keep =</span> <span class="op">~</span><span class="kw">ifelse</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2013</span>,<span class="dv">2014</span>), <span class="dv">20</span>,<span class="dv">21</span>),
                <span class="dt">new_file =</span> <span class="op">~</span><span class="kw">paste0</span>(<span class="st">&quot;green_tripdata_&quot;</span>, year, <span class="st">&quot;_&quot;</span>, 
                                   stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>),
                                   <span class="st">&quot;.csv&quot;</span>))
      src_small_green_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">intersect</span>(src, remote_green_<span class="dv">2</span><span class="op">$</span>src)
      src_small_green_2_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(src_small_green_<span class="dv">2</span>) 
      <span class="kw">names</span>(src_small_green_2_df) &lt;-<span class="st"> &quot;src&quot;</span>
      src_small_green_2_df &lt;-<span class="st"> </span><span class="kw">inner_join</span>(src_small_green_2_df, remote_green_<span class="dv">2</span>, <span class="dt">by =</span> <span class="st">&quot;src&quot;</span>)
      src_small_green_2_df &lt;-<span class="st"> </span>src_small_green_2_df <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate</span>(<span class="dt">cmds_2 =</span> <span class="kw">paste</span>(<span class="st">&quot;cut -d, -f1-&quot;</span>, keep,<span class="st">&quot; &quot;</span>,src, <span class="st">&quot; &gt; &quot;</span>,<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>),<span class="st">&quot;/green_tripdata_&quot;</span>, 
                              year, <span class="st">&quot;_&quot;</span>, stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>),<span class="st">&quot;.csv&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))
      <span class="co">#remove the extra column</span>
      <span class="cf">if</span>(<span class="kw">length</span>(src_small_green_<span class="dv">2</span>) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {
        <span class="cf">if</span> (.Platform<span class="op">$</span>OS.type <span class="op">==</span><span class="st"> &quot;unix&quot;</span>){
          <span class="kw">lapply</span>(src_small_green_2_df<span class="op">$</span>cmds_<span class="dv">2</span>, system)} 
        <span class="cf">else</span> {
          <span class="kw">message</span>(<span class="st">&quot;Windows system does not currently support removing the 2nd blank row </span>
<span class="st">                  in the green taxi datasets. This might affect loading data into SQL...&quot;</span>)}
        }<span class="cf">else</span> {
          <span class="st">&quot;All the green taxi data you requested are in cleaned formats.&quot;</span>}
      <span class="co">#Find the files paths of the files that need to be transformed----------------------</span>
      <span class="kw">file.rename</span>(<span class="kw">file.path</span>(<span class="kw">dirname</span>(src_small_green_2_df<span class="op">$</span>src),
                            src_small_green_2_df<span class="op">$</span>new_file), 
                  <span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), <span class="kw">basename</span>(src_small_green_2_df<span class="op">$</span>src)))
      <span class="co">#Move the files</span>
      in_raw &lt;-<span class="st"> </span><span class="kw">basename</span>(src_small)
      in_load &lt;-<span class="st"> </span><span class="kw">basename</span>(<span class="kw">list.files</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), <span class="st">&quot;green&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>))
      file_remian &lt;-<span class="st"> </span><span class="kw">setdiff</span>(in_raw,in_load)
      <span class="kw">file.copy</span>(<span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>),file_remian), <span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>),file_remian) )}}
  <span class="co">#UBER----------------------------------------------------------------</span>
  uber &lt;-<span class="st"> </span><span class="cf">function</span>(obj) {
    <span class="kw">message</span>(<span class="st">&quot;Transforming uber data from raw to load directory...&quot;</span>)
    <span class="co">#creat a list of 2014 uber data file directory</span>
    uber14_list &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>), <span class="dt">pattern =</span> <span class="st">&quot;14.csv&quot;</span>)
    uber14_list &lt;-<span class="st"> </span><span class="kw">data.frame</span>(uber14_list)
    uber14_list &lt;-<span class="st"> </span>uber14_list <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_</span>(<span class="dt">file_path =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>), uber14_list))
    uber14file &lt;-<span class="st"> </span><span class="kw">lapply</span>(uber14_list<span class="op">$</span>file_path, readr<span class="op">::</span>read_csv)
    n &lt;-<span class="st"> </span><span class="kw">length</span>(uber14file)
    <span class="cf">if</span> (n <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {
      uber14 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(uber14file[<span class="dv">1</span>])
    } <span class="cf">else</span> <span class="cf">if</span> (n <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) {
      uber14 &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(uber14file[<span class="dv">1</span>], uber14file[<span class="dv">2</span>])
    } <span class="cf">else</span> <span class="cf">if</span> (n <span class="op">&gt;</span><span class="st"> </span><span class="dv">2</span>) {
      uber14 &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(uber14file[<span class="dv">1</span>], uber14file[<span class="dv">2</span>])
      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">3</span><span class="op">:</span>n){uber14 &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(uber14, uber14file[i])}
    }
    substrRight &lt;-<span class="st"> </span><span class="cf">function</span>(x, n){<span class="kw">substr</span>(x, <span class="kw">nchar</span>(x)<span class="op">-</span>n<span class="op">+</span><span class="dv">1</span>, <span class="kw">nchar</span>(x))}
    uber14_datetime &lt;-<span class="st"> </span>uber14 <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">gsub</span>( <span class="st">&quot; .*$&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">`</span><span class="dt">Date/Time</span><span class="st">`</span>), <span class="dt">len_date =</span> <span class="kw">nchar</span>(date), 
             <span class="dt">time =</span> <span class="kw">sub</span>(<span class="st">&#39;.*</span><span class="ch">\\</span><span class="st"> &#39;</span>, <span class="st">&#39;&#39;</span>, <span class="st">`</span><span class="dt">Date/Time</span><span class="st">`</span>))
    uber14_datetime &lt;-<span class="st"> </span>uber14_datetime <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">month =</span> <span class="kw">substr</span>(<span class="st">`</span><span class="dt">Date/Time</span><span class="st">`</span>, <span class="dv">1</span>, <span class="dv">1</span>),
             <span class="dt">day =</span> <span class="kw">ifelse</span>(len_date <span class="op">==</span><span class="st"> </span><span class="dv">8</span>, <span class="kw">substr</span>(<span class="st">`</span><span class="dt">Date/Time</span><span class="st">`</span>, <span class="dv">3</span>,<span class="dv">3</span>),<span class="kw">substr</span>(<span class="st">`</span><span class="dt">Date/Time</span><span class="st">`</span>, <span class="dv">3</span>,<span class="dv">4</span>)),
             <span class="dt">pickup_date =</span> lubridate<span class="op">::</span><span class="kw">ymd_hms</span>(<span class="kw">paste0</span>(<span class="st">&quot;2014-&quot;</span>, month, <span class="st">&quot;-&quot;</span>, day, <span class="st">&quot; &quot;</span>, time)))
    uber14_df &lt;-<span class="st"> </span>uber14_datetime[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">5</span><span class="op">:</span><span class="dv">9</span>)]
    
    <span class="co">#2015</span>
    zipped_uberfileURL &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>), <span class="st">&quot;uber-raw-data-janjune-15.csv.zip&quot;</span>)
    raw_month_<span class="dv">2015</span> &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(<span class="dt">years =</span> <span class="dv">2015</span>, <span class="dt">months =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>)
    remote_<span class="dv">2015</span> &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months)
    remote_small_<span class="dv">2015</span> &lt;-<span class="st"> </span><span class="kw">inner_join</span>(raw_month_<span class="dv">2015</span>, remote_<span class="dv">2015</span>)
    <span class="cf">if</span>(<span class="kw">file.exists</span>(zipped_uberfileURL) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">nrow</span>(remote_small_<span class="dv">2015</span>) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>){
      utils<span class="op">::</span><span class="kw">unzip</span>(<span class="dt">zipfile =</span> zipped_uberfileURL, 
                   <span class="dt">unzip =</span> <span class="st">&quot;internal&quot;</span>,
                   <span class="dt">exdir =</span> <span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;uber-raw-data-janjune-15.csv.zip&quot;</span>))
      uber15 &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw">read_csv</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;uber-raw-data-janjune-15.csv.zip&quot;</span>,<span class="st">&quot;uber-raw-data-janjune-15.csv&quot;</span>))}
    
    <span class="kw">names</span>(uber14_df) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lat&quot;</span>, <span class="st">&quot;lon&quot;</span>, <span class="st">&quot;affiliated_base_num&quot;</span>, <span class="st">&quot;pickup_date&quot;</span>)
    <span class="kw">names</span>(uber15) &lt;-<span class="st"> </span><span class="kw">tolower</span>(<span class="kw">names</span>(uber15))
    uber &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(uber14_df, uber15)
    utils<span class="op">::</span><span class="kw">write.csv</span>(uber, <span class="kw">file.path</span>(<span class="kw">tempdir</span>() ,<span class="st">&quot;uber.csv&quot;</span>))
    <span class="cf">if</span>(<span class="kw">nrow</span>(uber) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {
      <span class="cf">if</span> (.Platform<span class="op">$</span>OS.type <span class="op">==</span><span class="st"> &quot;unix&quot;</span>){
        cmds_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;cut -d, -f2-7 &quot;</span>,<span class="kw">file.path</span>(<span class="kw">tempdir</span>(),<span class="st">&quot;uber.csv&quot;</span>), <span class="st">&quot; &gt; &quot;</span>, <span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>),<span class="st">&quot;uber.csv&quot;</span>))
        <span class="kw">lapply</span>(cmds_<span class="dv">3</span>, system)
      } <span class="cf">else</span> {
        <span class="kw">message</span>(<span class="st">&quot;Windows system does not currently support removing the 2nd blank row </span>
<span class="st">                in the green taxi datasets. This might affect loading data into SQL...&quot;</span>)}
      }<span class="cf">else</span> {
        <span class="st">&quot;You did not request for any green taxi data, or all the green taxi data you requested are cleaned.&quot;</span>}
    }
  <span class="co">#LYFT----------------------------------------------------------------</span>
  lyft &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months){
    valid_months &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, <span class="dt">months =</span> <span class="dv">1</span>, <span class="dt">begin =</span> <span class="st">&quot;2015-01-01&quot;</span>)
    <span class="kw">message</span>(<span class="st">&quot;Transforming lyft data from raw to load directory...&quot;</span>)
    src &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw_dir&quot;</span>), <span class="st">&quot;lyft&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
    src_year &lt;-<span class="st"> </span>valid_months <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct_</span>(<span class="op">~</span>year)
    remote &lt;-<span class="st"> </span><span class="kw">data_frame</span>(src)
    remote &lt;-<span class="st"> </span>remote <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">lcl =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>),<span class="kw">basename</span>(src)),
              <span class="dt">basename =</span> <span class="op">~</span><span class="kw">basename</span>(src), <span class="dt">year =</span> <span class="op">~</span><span class="kw">substr</span>(basename,<span class="dv">6</span>,<span class="dv">9</span>))
    <span class="kw">class</span>(remote<span class="op">$</span>year) &lt;-<span class="st"> &quot;numeric&quot;</span>
    remote &lt;-<span class="st"> </span><span class="kw">inner_join</span>(remote,src_year, <span class="dt">by =</span> <span class="st">&quot;year&quot;</span> )
    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(remote)) {
        datafile &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw">read_csv</span>(remote<span class="op">$</span>src[i])
        readr<span class="op">::</span><span class="kw">write_delim</span>(datafile, <span class="dt">path =</span> remote<span class="op">$</span>lcl[i], <span class="dt">delim =</span> <span class="st">&quot;|&quot;</span>, <span class="dt">na =</span> <span class="st">&quot;&quot;</span>)}}
  
  <span class="co">#transform the data from raw to load</span>
  <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;yellow&quot;</span>){<span class="kw">taxi_yellow</span>(obj, years, months)} 
  <span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;green&quot;</span>){<span class="kw">taxi_green</span>(obj, years, months)}
  <span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;uber&quot;</span>){<span class="kw">uber</span>(obj)}
  <span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;lyft&quot;</span>){<span class="kw">lyft</span>(obj, years, months)}
  <span class="cf">else</span> {<span class="kw">message</span>(<span class="st">&quot;The type you chose does not exit...&quot;</span>)}
  
  <span class="kw">invisible</span>(obj)
}</code></pre></div>
</div>
<div id="etl-load" class="section level3">
<h3><span class="header-section-number">3.7.3</span> ETL Load</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">etl_load.etl_nyctaxi &lt;-<span class="st"> </span><span class="cf">function</span>(obj, <span class="dt">years =</span> <span class="kw">as.numeric</span>(<span class="kw">format</span>(<span class="kw">Sys.Date</span>(),<span class="st">&#39;%Y&#39;</span>)), 
                                 <span class="dt">months =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, 
                                 <span class="dt">type  =</span> <span class="st">&quot;yellow&quot;</span>, ...) {
  <span class="co">#TAXI YELLOW----------------------------------------------------------------</span>
  taxi_yellow &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months,...) {
    <span class="co">#create a df of file path of the files that are in the load directory</span>
    src &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), <span class="st">&quot;yellow&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
    src &lt;-<span class="st"> </span><span class="kw">data.frame</span>(src)
    
    <span class="co">#files before 2016-07</span>
    remote_old &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2009-01-01&quot;</span>, <span class="dt">end =</span> <span class="st">&quot;2016-06-30&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), 
                               <span class="kw">paste0</span>(<span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;_tripdata_&quot;</span>, year, <span class="st">&quot;-&quot;</span>,
                                      stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>), <span class="st">&quot;.csv&quot;</span>))) 
    src_small_old &lt;-<span class="st"> </span><span class="kw">inner_join</span>(remote_old, src, <span class="dt">by =</span> <span class="st">&quot;src&quot;</span>)
    <span class="co">#files later then 2017-06</span>
    remote_new &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2016-07-01&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), 
                               <span class="kw">paste0</span>(<span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;_tripdata_&quot;</span>, year, <span class="st">&quot;-&quot;</span>,
                                      stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>), <span class="st">&quot;.csv&quot;</span>))) 
    src_small_new &lt;-<span class="st"> </span><span class="kw">inner_join</span>(remote_new, src, <span class="dt">by =</span> <span class="st">&quot;src&quot;</span>)
    <span class="co">#data earlier than 2016-07</span>
    <span class="cf">if</span>(<span class="kw">nrow</span>(src_small_old) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
      <span class="kw">message</span>(<span class="st">&quot;The taxi files (earlier than 2016-07) you requested are not available in the load directory...&quot;</span>)
    } <span class="cf">else</span> {
      <span class="kw">message</span>(<span class="st">&quot;Loading taxi data from load directory to a sql database...&quot;</span>)
      <span class="kw">mapply</span>(DBI<span class="op">::</span>dbWriteTable, 
             <span class="dt">name =</span> <span class="st">&quot;yellow_old&quot;</span>, <span class="dt">value =</span> src_small_old<span class="op">$</span>src, 
             <span class="dt">MoreArgs =</span> <span class="kw">list</span>(<span class="dt">conn =</span> obj<span class="op">$</span>con, <span class="dt">append =</span> <span class="ot">TRUE</span>))}
    
    <span class="co">#data later then 2016-06</span>
    <span class="cf">if</span>(<span class="kw">nrow</span>(src_small_new) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
      <span class="kw">message</span>(<span class="st">&quot;The new taxi files (later than 2016-06) you requested are not available in the load directory...&quot;</span>)
    } <span class="cf">else</span> {
      <span class="kw">message</span>(<span class="st">&quot;Loading taxi data from load directory to a sql database...&quot;</span>)
      <span class="kw">mapply</span>(DBI<span class="op">::</span>dbWriteTable, 
             <span class="dt">name =</span> <span class="st">&quot;yellow&quot;</span>, <span class="dt">value =</span> src_small_new<span class="op">$</span>src, 
             <span class="dt">MoreArgs =</span> <span class="kw">list</span>(<span class="dt">conn =</span> obj<span class="op">$</span>con, <span class="dt">append =</span> <span class="ot">TRUE</span>))}
    
    }
  <span class="co">#TAXI GREEN----------------------------------------------------------------</span>
  taxi_green &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months,...) {
    <span class="co">#create a list of file that the user wants to load</span>
    remote &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2013-08-01&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate_</span>(<span class="dt">src =</span> <span class="op">~</span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), 
                               <span class="kw">paste0</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;_tripdata_&quot;</span>, year, <span class="st">&quot;-&quot;</span>,
                                      stringr<span class="op">::</span><span class="kw">str_pad</span>(month, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>), <span class="st">&quot;.csv&quot;</span>)))
    <span class="co">#create a df of file path of the files that are in the load directory</span>
    src &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), <span class="st">&quot;tripdata&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
    src &lt;-<span class="st"> </span><span class="kw">data.frame</span>(src)
    <span class="co">#only keep the files thst the user wants to transform</span>
    src_small &lt;-<span class="st"> </span><span class="kw">inner_join</span>(remote, src, <span class="dt">by =</span> <span class="st">&quot;src&quot;</span>)
    <span class="cf">if</span>(<span class="kw">nrow</span>(src_small) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
      <span class="kw">message</span>(<span class="st">&quot;The taxi files you requested are not available in the load directory...&quot;</span>)
    } <span class="cf">else</span> {
      <span class="kw">message</span>(<span class="st">&quot;Loading taxi data from load directory to a sql database...&quot;</span>)
      <span class="kw">mapply</span>(DBI<span class="op">::</span>dbWriteTable, 
             <span class="dt">name =</span> <span class="st">&quot;green&quot;</span>, <span class="dt">value =</span> src_small<span class="op">$</span>src, 
             <span class="dt">MoreArgs =</span> <span class="kw">list</span>(<span class="dt">conn =</span> obj<span class="op">$</span>con, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">... =</span> ...))}}
  <span class="co">#UBER----------------------------------------------------------------</span>
  uber &lt;-<span class="st"> </span><span class="cf">function</span>(obj,...) {
    uberfileURL &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), <span class="st">&quot;uber.csv&quot;</span>)
    <span class="cf">if</span>(<span class="kw">file.exists</span>(uberfileURL)) {
      <span class="kw">message</span>(<span class="st">&quot;Loading uber data from load directory to a sql database...&quot;</span>)
      DBI<span class="op">::</span><span class="kw">dbWriteTable</span>(<span class="dt">conn =</span> obj<span class="op">$</span>con, <span class="dt">name =</span> <span class="st">&quot;uber&quot;</span>, 
                        <span class="dt">value =</span> uberfileURL, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">... =</span> ...)
    } <span class="cf">else</span> {
      <span class="kw">message</span>(<span class="st">&quot;There is no uber data in the load directory...&quot;</span>)}}
  <span class="co">#LYFT----------------------------------------------------------------</span>
  lyft &lt;-<span class="st"> </span><span class="cf">function</span>(obj, years, months,...){
    <span class="kw">message</span>(<span class="st">&quot;Loading lyft data from load directory to a sql database...&quot;</span>)
    <span class="co">#create a list of file that the user wants to load</span>
    valid_months &lt;-<span class="st"> </span>etl<span class="op">::</span><span class="kw">valid_year_month</span>(years, months, <span class="dt">begin =</span> <span class="st">&quot;2015-01-01&quot;</span>)
    src &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;load_dir&quot;</span>), <span class="st">&quot;lyft&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
    src_year &lt;-<span class="st"> </span>valid_months <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct_</span>(<span class="op">~</span>year)
    remote &lt;-<span class="st"> </span><span class="kw">data_frame</span>(src)
    remote &lt;-<span class="st"> </span>remote <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_</span>(<span class="dt">tablename =</span> <span class="op">~</span><span class="st">&quot;lyft&quot;</span>, <span class="dt">year =</span> <span class="op">~</span><span class="kw">substr</span>(<span class="kw">basename</span>(src),<span class="dv">6</span>,<span class="dv">9</span>))
    <span class="kw">class</span>(remote<span class="op">$</span>year) &lt;-<span class="st"> &quot;numeric&quot;</span>
    remote &lt;-<span class="st"> </span><span class="kw">inner_join</span>(remote,src_year, <span class="dt">by =</span> <span class="st">&quot;year&quot;</span> )
    <span class="cf">if</span>(<span class="kw">nrow</span>(remote) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {
      write_data &lt;-<span class="st"> </span><span class="cf">function</span>(...) {
        <span class="kw">lapply</span>(remote<span class="op">$</span>src, <span class="dt">FUN =</span> DBI<span class="op">::</span>dbWriteTable, <span class="dt">conn =</span> obj<span class="op">$</span>con, 
               <span class="dt">name =</span> <span class="st">&quot;lyft&quot;</span>, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">sep =</span> <span class="st">&quot;|&quot;</span>, <span class="dt">... =</span> ...)}
      <span class="kw">write_data</span>(...)
    } <span class="cf">else</span> {
      <span class="kw">message</span>(<span class="st">&quot;The lyft files you requested are not available in the load directory...&quot;</span>)}}
  
  <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;yellow&quot;</span>){<span class="kw">taxi_yellow</span>(obj, years, months,...)
  }<span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;green&quot;</span>){<span class="kw">taxi_green</span>(obj, years, months,...)
  }<span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;uber&quot;</span>){<span class="kw">uber</span>(obj,...)
  }<span class="cf">else</span> <span class="cf">if</span> (type <span class="op">==</span><span class="st"> &quot;lyft&quot;</span>){<span class="kw">lyft</span>(obj, years, months,...)
  }<span class="cf">else</span> {<span class="kw">message</span>(<span class="st">&quot;The type you chose does not exit...&quot;</span>)
            }
  
  <span class="kw">invisible</span>(obj)
}</code></pre></div>
</div>
<div id="utils" class="section level3">
<h3><span class="header-section-number">3.7.4</span> utils</h3>
<p>This utility function below was written to shortened the source code in ETL extract.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">download_nyc_data &lt;-<span class="st"> </span><span class="cf">function</span>(obj, url, years, n, names, ...) {
  url &lt;-<span class="st"> </span><span class="kw">paste0</span>(url,<span class="st">&quot;?years=&quot;</span>,
                years,<span class="st">&quot;&amp;$limit=&quot;</span>, n)
  lcl &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">attr</span>(obj, <span class="st">&quot;raw&quot;</span>), names)
  downloader<span class="op">::</span><span class="kw">download</span>(url, <span class="dt">destfile =</span> lcl, ...)
  lcl
}</code></pre></div>
</div>
<div id="etl-init" class="section level3">
<h3><span class="header-section-number">3.7.5</span> ETL Init</h3>
<p>DROP TABLE IF EXISTS <code>yellow_old</code>;</p>
<p>CREATE TABLE <code>yellow_old</code> ( <code>VendorID</code> tinyint DEFAULT NULL, <code>tpep_pickup_datetime</code> DATETIME NOT NULL, <code>tpep_dropoff_datetime</code> DATETIME NOT NULL, <code>passenger_count</code> tinyint DEFAULT NULL, <code>trip_distance</code> float(10,2) DEFAULT NULL, <code>pickup_longitude</code> double(7,5) DEFAULT NULL, <code>pickup_latitude</code> double(7,5) DEFAULT NULL, <code>RatecodeID</code> tinyint DEFAULT NULL, <code>store_and_fwd_flag</code> varchar(10) COLLATE latin1_general_ci DEFAULT NULL, <code>dropoff_longitude</code> double(7,5) DEFAULT NULL, <code>dropoff_latitude</code> double(7,5) DEFAULT NULL, <code>payment_type</code> tinyint DEFAULT NULL, <code>fare_amount</code> decimal(5,3) DEFAULT NULL, <code>extra</code> decimal(5,3) DEFAULT NULL, <code>mta_tax</code> decimal(5,3) DEFAULT NULL, <code>tip_amount</code> decimal(5,3) DEFAULT NULL, <code>tolls_amount</code> decimal(5,3) DEFAULT NULL, <code>improvement_surcharge</code> decimal(5,3) DEFAULT NULL, <code>total_amount</code> decimal(5,3) DEFAULT NULL, KEY <code>VendorID</code> (<code>VendorID</code>), KEY <code>pickup_datetime</code> (<code>tpep_pickup_datetime</code>), KEY <code>dropoff_datetime</code> (<code>tpep_dropoff_datetime</code>), KEY <code>pickup_longitude</code> (<code>pickup_longitude</code>), KEY <code>pickup_latitude</code> (<code>pickup_latitude</code>), KEY <code>dropoff_longitude</code> (<code>dropoff_longitude</code>), KEY <code>dropoff_latitude</code> (<code>dropoff_latitude</code>) ) PARTITION BY RANGE( YEAR(tpep_pickup_datetime) ) ( PARTITION p09 VALUES LESS THAN (2010), PARTITION p10 VALUES LESS THAN (2011), PARTITION p11 VALUES LESS THAN (2012), PARTITION p12 VALUES LESS THAN (2013), PARTITION p13 VALUES LESS THAN (2014), PARTITION p14 VALUES LESS THAN (2015), PARTITION p15 VALUES LESS THAN (2016), PARTITION p16 VALUES LESS THAN (2017) );</p>
<p>DROP TABLE IF EXISTS <code>yellow</code>;</p>
<p>CREATE TABLE <code>yellow</code> ( <code>VendorID</code> tinyint DEFAULT NULL, <code>tpep_pickup_datetime</code> DATETIME NOT NULL, <code>tpep_dropoff_datetime</code> DATETIME NOT NULL, <code>passenger_count</code> tinyint DEFAULT NULL, <code>trip_distance</code> float(10,2) DEFAULT NULL, <code>RatecodeID</code> tinyint DEFAULT NULL, <code>store_and_fwd_flag</code> varchar(10) COLLATE latin1_general_ci DEFAULT NULL, <code>PULocationID</code> tinyint DEFAULT NULL, <code>DOLocationID</code> tinyint DEFAULT NULL, <code>payment_type</code> tinyint DEFAULT NULL, <code>fare_amount</code> decimal(5,3) DEFAULT NULL, <code>extra</code> decimal(5,3) DEFAULT NULL, <code>mta_tax</code> decimal(5,3) DEFAULT NULL, <code>tip_amount</code> decimal(5,3) DEFAULT NULL, <code>tolls_amount</code> decimal(5,3) DEFAULT NULL, <code>improvement_surcharge</code> decimal(5,3) DEFAULT NULL, <code>total_amount</code> decimal(5,3) DEFAULT NULL, KEY <code>VendorID</code> (<code>VendorID</code>), KEY <code>pickup_datetime</code> (<code>tpep_pickup_datetime</code>), KEY <code>dropoff_datetime</code> (<code>tpep_dropoff_datetime</code>), KEY <code>PULocationID</code> (<code>PULocationID</code>), KEY <code>DOLocationID</code> (<code>DOLocationID</code>) ) PARTITION BY RANGE( YEAR(tpep_pickup_datetime) ) ( PARTITION p16 VALUES LESS THAN (2017), PARTITION p17 VALUES LESS THAN (2018) );</p>
<p>DROP TABLE IF EXISTS <code>green</code>;</p>
<p>CREATE TABLE <code>green</code> ( <code>VendorID</code> tinyint DEFAULT NULL, <code>lpep_pickup_datetime</code> DATETIME NOT NULL, <code>Lpep_dropoff_datetime</code> DATETIME NOT NULL, <code>Store_and_fwd_flag</code> varchar(10) COLLATE latin1_general_ci DEFAULT NULL, <code>RatecodeID</code> tinyint DEFAULT NULL, <code>Pickup_longitude</code> double(7,5) DEFAULT NULL, <code>Pickup_latitude</code> double(7,5) DEFAULT NULL, <code>Dropoff_longitude</code> double(7,5) DEFAULT NULL, <code>Dropoff_latitude</code> double(7,5) DEFAULT NULL, <code>Passenger_count</code> tinyint DEFAULT NULL, <code>Trip_distance</code> float(10,2) DEFAULT NULL, <code>Fare_amount</code> decimal(5,3) DEFAULT NULL, <code>Extra</code> decimal(5,3) DEFAULT NULL, <code>MTA_tax</code> decimal(5,3) DEFAULT NULL, <code>Tip_amount</code> decimal(5,3) DEFAULT NULL, <code>Tolls_amount</code> decimal(5,3) DEFAULT NULL, <code>improvement_surcharge</code> decimal(5,3) DEFAULT NULL, <code>Total_amount</code> decimal(5,3) DEFAULT NULL, <code>Payment_type</code> tinyint DEFAULT NULL, <code>Trip_type</code> tinyint DEFAULT NULL, KEY <code>VendorID</code> (<code>VendorID</code>), KEY <code>pickup_datetime</code> (<code>lpep_pickup_datetime</code>), KEY <code>dropoff_datetime</code> (<code>Lpep_dropoff_datetime</code>) );</p>
<p>DROP TABLE IF EXISTS <code>lyft</code>;</p>
<p>CREATE TABLE <code>lyft</code> ( <code>base_license_number</code> varchar(15) COLLATE latin1_general_ci DEFAULT NULL, <code>base_name</code> varchar(40) COLLATE latin1_general_ci DEFAULT NULL, <code>dba</code> varchar(40) COLLATE latin1_general_ci DEFAULT NULL, <code>pickup_end_date</code> DATE NOT NULL, <code>pickup_start_date</code> DATE NOT NULL, <code>total_dispatched_trips</code> smallint DEFAULT NULL, <code>unique_dispatched_vehicle</code> smallint DEFAULT NULL, <code>wave_number</code> tinyint DEFAULT NULL, <code>week_number</code> tinyint DEFAULT NULL, <code>years</code> smallint DEFAULT NULL, KEY <code>base_name</code> (<code>base_name</code>), KEY <code>pickup_end_date</code> (<code>pickup_end_date</code>), KEY <code>pickup_start_date</code> (<code>pickup_start_date</code>) );</p>
<p>DROP TABLE IF EXISTS <code>uber</code>;</p>
<p>CREATE TABLE <code>uber</code> ( <code>lat</code> double(7,5) DEFAULT NULL, <code>lon</code> double(7,5) DEFAULT NULL, <code>dispatching_base_num</code> varchar(15) COLLATE latin1_general_ci DEFAULT NULL, <code>pickup_date</code> DATETIME NOT NULL, <code>affiliated_base_num</code> varchar(15) COLLATE latin1_general_ci DEFAULT NULL, <code>locationid</code> tinyint DEFAULT NULL, KEY <code>pickup_date</code> (<code>pickup_date</code>), KEY <code>locationid</code> (<code>locationid</code>) );</p>
<p>CREATE VIEW yellow_old_sum AS SELECT YEAR(tpep_pickup_datetime) as the_year, MONTH(tpep_pickup_datetime) AS the_month, count(*) AS num_trips FROM yellow_old GROUP BY the_year, the_month; );</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="2-introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="4-chapter2.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": [["thesis.pdf", "PDF"], ["thesis.epub", "EPUB"], ["thesis.docx", "Word"]],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
