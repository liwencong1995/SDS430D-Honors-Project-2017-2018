```{r, message=FALSE, echo=FALSE}
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

# New York City Taxi Driver {#chapter3}
## Get Yellow Taxi Trip Data Ready for Data Analysis
The income of Taxi drivers in New York City has two parts: taxi fare and tips. Taxi fare is usually calculated by the meters installed in the taxis, and the rate of fare cannot be changed by taxi drivers. Therefore, in order to make more profit, taxi drivers prefer to pick up passengers who offer big amount of tips. What are the regions that provide the most tips to yellow taxicab drivers?

In the following analysis, I will focus on trip data collected in 2017. Taxi drivers usually does not correctly record the amount of tips paid by cash or check. Therefore, in order to find out the regions that offer the most tips, we need to filter out the trips that are not paid by credit or debit card.

```{r, message=FALSE, echo=FALSE, eval=FALSE}
library(knitr)
library(dplyr)
library(lubridate)
library(stringr)
library(etl)
library(ggplot2)
library(htmlwidgets)
library(webshot)
library(sp)

data("taxi_zone_lookup")
data("taxi_zones")
```

```{r}
db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)
```

As mentioned in the previous chapter, that we can utlize the connection to a MySQL database to run data analysis in MySQL for medium-sized data.
Since we are using all 12 month data from 2017 in this analysis, it is impossible to load all data needed into R environment. Instead, we want to only load a fraction of the 2017 Yellow Taxi data from MySQL database. 

In this section, we only want to load trip records with payment type equals to 1, which represents credit card. Only trip records with payment type credit card have accurate information on tip amount. Let's load the 2017 trip record into R environment by using the MySQL connection we just generated, `taxi`.
```{r, eval=FALSE}
yellow_2017 <- taxi %>%
  tbl("yellow") %>%
  filter(payment_type == 1) %>%
  collect(n = Inf)
```

```{r, echo=FALSE, message=FALSE, eval=FALSE}
#second half
yellow_2017_2 <- taxi %>%
  tbl("yellow") %>%
  filter(payment_type == 1) %>%
  filter(month(tpep_pickup_datetime) > 6) %>%
  collect(n = Inf)

yellow_2017_summary_2 <- yellow_2017_2 %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(duration = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2) ) %>%
  mutate(duration = as.numeric(duration)) %>%
  filter(duration > 0) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 0) %>%
  filter(payment_type ==1 | payment_type == 2) %>%
  mutate(year = year(tpep_pickup_datetime),
         month = month(tpep_pickup_datetime),
         tip_perct = tip_amount/fare_amount) %>%
  group_by(year, month, PULocationID, DOLocationID) %>%
  summarise(avg_tip = mean(tip_perct), 
            trips = n(),
            avg_dis = mean(trip_distance),
            avg_duration = mean(duration))

db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)

#first half
yellow_2017_1 <- taxi %>%
  tbl("yellow") %>%
  filter(payment_type == 1) %>%
  filter(month(tpep_pickup_datetime) < 7) %>%
  collect(n = Inf)

yellow_2017_summary_1 <- yellow_2017_1 %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(duration = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2) ) %>%
  mutate(duration = as.numeric(duration)) %>%
  filter(duration > 0) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 0) %>%
  filter(payment_type ==1 | payment_type == 2) %>%
  mutate(year = year(tpep_pickup_datetime),
         month = month(tpep_pickup_datetime),
         tip_perct = tip_amount/fare_amount) %>%
  group_by(year, month, PULocationID, DOLocationID) %>%
  summarise(avg_tip = mean(tip_perct), 
            trips = n(),
            avg_dis = mean(trip_distance),
            avg_duration = mean(duration))

#Combine summary_2 and summary_1
yellow_2017_summary <- bind_rows(yellow_2017_summary_1, yellow_2017_summary_2)
```

## Aggregated Zone-level Tip Information
Comparing to studying factors that affect individual trips' percent tip, it is more meaningful to study the aggregated effect of each zone on percent tip, since the results are more concise and comprehensible. Instead of the absolute amount of tips, we want to focus on the percentage of tips that passengers pay in addition to the total fare amount. Therefore, we use tip amount over fare amount to calculate the percent tip.

```{r, eval=FALSE}
yellow_2017_summary <- yellow_2017 %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(duration = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2) ) %>%
  mutate(duration = as.numeric(duration)) %>%
  filter(duration > 0) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  mutate(year = year(tpep_pickup_datetime),
         month = month(tpep_pickup_datetime),
         tip_perct = tip_amount/fare_amount) %>%
  group_by(year, month, PULocationID, DOLocationID) %>%
  summarise(avg_tip = mean(tip_perct), 
            trips = n(),
            avg_dis = mean(trip_distance),
            avg_duration = mean(duration))
```

```{r, echo=FALSE, eval=FALSE}
fwrite(yellow_2017_summary, "/Users/priscilla/Desktop/Honors Thesis/data/yellow_2017_summary.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(data.table)
yellow_2017_summary <- data.table::fread("/Users/priscilla/Desktop/Honors Thesis/data/yellow_2017_summary.csv")
```

Each taxi trip has pick-up and drop-off locations associated with it, and there are 263 known taxi zones. 
```{r tip-region, fig.cap="Percent Tip Paid by Passengers on Each Pick-up And Drop-off Pair in NYC", echo=FALSE, message=FALSE}
tip_region <- yellow_2017_summary %>%
  rename(LocationID = PULocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(PULocationID = LocationID) %>%
  arrange(year, month, desc(avg_tip)) %>%
  rename(LocationID = DOLocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(DOLocationID = LocationID) %>%
  arrange(year, month, desc(avg_tip)) %>%
  filter(Zone.x != "Unknown") %>%
  filter(Zone.y != "Unknown")

region_vis <- ggplot(data = tip_region, aes(x = avg_tip) ) +
  xlab("Tips, percent") +
  geom_histogram(binwidth = 0.005) + 
  geom_vline(xintercept = c(0.20), col = "red",linetype = "longdash") +
  geom_vline(xintercept = c(0.25), col = "green",linetype = "longdash") +
  geom_vline(xintercept = c(0.28), col = "yellow",linetype = "longdash") + 
  scale_x_continuous(limits = c(0, 0.5))
region_vis
```
Figure \@ref(fig:tip-region) is a histogram of mean tip percents for all known pick-up and drop-off zone pairs.

### Pick-up Zone Tip Information
Taxi drivers are required to be indifferent to where passengers are going. Therefore, it makes sense to investigate the average amount of tips paid for each pick-up zone. What are the taxi pick-up zones that have the highest tip percents?

We first calculate the average percent tip paid for each pick-up zone. 
```{r, message=FALSE, echo=FALSE}
tip_pickup <- yellow_2017_summary %>%
  group_by(year, month, PULocationID) %>%
  summarise(avg_tip = round(mean(avg_tip), 2), 
            num_trips=sum(trips),
            avg_dis = round(mean(avg_dis),2),
            avg_duration = round(mean(avg_duration),2)) %>%
  rename(LocationID = PULocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(PULocationID = LocationID) %>%
  arrange(year, month, desc(avg_tip)) %>%
  filter(Zone != "Unknown")
```

```{r, message=FALSE, echo=FALSE}
kable(tip_pickup[1:10,], caption = "Ten taxi pick-up zones with the highest average tip without any threshold in Janaury, 2017",
      booktabs = TRUE)
```
Table \@ref(tab:tip_pickup) is a list of pick-up zones with their average percent tip.

Below is a histogram of average percent tips paid for all pick-up zones. 

```{r pickup-vis, fig.cap = "Percent Tip Paid by Passengers on Each Pick-up Taxi Zone in NYC", echo=FALSE, message=FALSE}
pickup_vis <- region_vis %+% tip_pickup
pickup_vis
```
As show in Figure \@ref(fig:pickup-vis), the first peak is around 20%, which is the cheapest default option on the touch panel for passengers to chose. 

**Does trip distance increase the percent tips paid?** 
One of the questions that I always wonder is whether longer trips result in higher tip percent. It takes taxi drivers more time to complete longer trips, so passengers might want to compensate taxi drivers more. I personally pay higher percent of tips for longer rides, so I believe trip distance has an impact on percentage of tips paid.

```{r, echo=FALSE}
tip_distance <- lm(avg_tip ~ avg_dis + PULocationID + DOLocationID, data = tip_region)
summary(tip_distance)$coef[1:2,]
```
Acoording to the simple linear regression result, trip distance does have a negative significant impact on the percent of tips paid, controlling for both pick-up and drop-off locations. This could be caused by a psycological reason. Long trips cost more than short trips. For a constant tip percent, the absolute value of tip amount cost more for longer trips. For example, for a \$100 trip, 20% tip costs \$20; for a \$50 trip, 20% tip costs \$10. Even though consumers are paying the same percent amount of tips, \$20 is more expensive than \$10. Therefore, consumers might decide to pay less percent tip for longer trips.

### Which taxi zones have the highest number of pick-ups?
Let's fist take a look at which pick-up zones have the highest number of pick-ups. 

```{r, message=FALSE, echo=FALSE}
tip_pickup_zone <- tip_pickup %>%
  group_by(PULocationID) %>%
  summarise(avg_tip = round(mean(avg_tip), 2), 
            num_trips=sum(num_trips),
            avg_dis = round(mean(avg_dis),2),
            avg_duration = round(mean(avg_duration),2)) %>%
  rename(LocationID = PULocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(PULocationID = LocationID) %>%
  arrange(desc(num_trips))

pick_up_zones <- merge(taxi_zones, tip_pickup_zone, by.x = "LocationID", by.y = "PULocationID")
```

We can create a heat map to visulizae the number of trip for each pick-up zones on a map of New York City Taxi Zones.
```{r, echo=FALSE, eval=FALSE}
reds = colorNumeric("Reds", domain = NULL)
#create visulization
num_trip <- leaflet(data = pick_up_zones) %>%
  addTiles() %>%
  addPolygons(fillColor = ~reds(num_trips),
              fillOpacity = 0.6,
              weight = 1,
              opacity = 0.2) %>%
  setView(lat = 40.7128, lng = -74.0060, zoom = 11)

saveWidget(num_trip, file = "/Users/priscilla/Desktop/Honors Thesis/figure/num_trip.html")
URL <- "/Users/priscilla/Desktop/Honors Thesis/figure/num_trip.html"
webshot(URL, "figure/num_trip.png", cliprect = "viewport")
```

```{r num-trip, fig.cap="Number of Pick-ups in Each Taxi Zone", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/num_trip.png", dpi = 200 )
```
According to Figure \@ref(fig:num-trip), It's obivous that Upper East Side Manhattan, Midtown Manhattan, and La Guardia Airport are the most popular location for pick-ups.

```{r, message=FALSE, echo=FALSE}
kable(tip_pickup_zone[1:10,], caption = "Ten taxi zones with the highest number of pick-ups")
```
Table \@ref(tab:tip_pickup_zone) gives you a better idea of which taxi zones have the highest number of pick-ups.

### Which taxi zones have the highest percent tips? 
Most yellow cab pick-ups occur in Manhattan. If we focus on the pick-up zones that have at least 30 trips per day or 10950 per year, we will observe that many taxi pick-up zones with highest percent tips are not necessarily the ones with the highest number of pick-ups. 
```{r}
#pick a threshold for the cutoff number of trips
pickup_zone_30 <- tip_pickup_zone %>%
  filter(num_trips >= (30*365)) %>%
  arrange(desc(avg_tip))
```

```{r, echo=FALSE}
kable(pickup_zone_30[1:10, ], caption = "Ten taxi pick-up zones with the highest percent tip (taxi zones has at least 30 pick-up per day)")
```
People might think it is more reasonable to ses a list that is populated with Zones in Manhattan, since that's where all the wealthy people live. However, Table \@ref(tab:pickup_zone_30) shows that passengers who get on taxis from certain zones in Brooklyn and Queens also pay a lot of tips. Taxi drivers who would love to get more tips compensation can drive to the zones listed above to pick-up passengers.

If we focus on the pick-up zones that have more than 3000 trips per day, then we observe that all pick-up zones that have the highest percent tips are in Manhattan besides La Guardia Airport.
```{r}
pickup_zone_3000 <- tip_pickup_zone %>%
  filter(num_trips >= (365*3000)) %>%
  arrange(desc(avg_tip))
```

```{r, echo=FALSE}
kable(pickup_zone_3000[1:10,], caption = "Ten taxi pick-up zones with the highest percent tip  (taxi zones has at least 3000 pick-up per day)")
```
There are more than 100 times more yellow cab pick-ups that happen in Manhattan everyday than in Brooklyn. By comparing the average tip percent in Table \@ref(tab:pickup_zone_30) and Table \@ref(tab:pickup_zone_3000), we can observe that percent tips paid in taxi zones with low pick-up numbers seem to be higher than percent tips paid in taxi zones with high pick-up numbers. 

## What features of taxi trips are attractive to taxi drivers?
So far, we have learned what pick-up zones offer the highest percent tip. Now, we want to dig into the relationships between percent tip and taxi-zone-specific variables. 

### Do taxi drivers tend to go to zones that offer high tips?
It is not easy to find an available taxi on the street on New York City, because the demand for taxi trips is much higher than the supply. Does paying high percent tips help customers to attract more taxis? 
If customers from certain regions keep paying higher tips, taxi drivers might be able to learn from their experiences in those regions, and be willing to wonder around those regions more often and pick up passengers. Pick-up zones with higher tips should attract more taxi drivers with the control of taxi zones. However, conflivting to what I assumed, Table \@ref(tab:pickup_zone_30) and Table \@ref(tab:pickup_zone_3000) show that percent tips seem to have a inverse relationship with number of pick-ups. 

Let's test the relationship between number of trips and average percent tips in each pick-up zone:
```{r, echo=FALSE}
tip_pickup$PULocationID <- as.character(tip_pickup$PULocationID)
tip_pickup$month <- as.character(tip_pickup$month)
tip_and_trip_1 <- lm(num_trips ~ avg_tip + month, data = tip_pickup)
summary(tip_and_trip_1)$coef[1:2,]
```
Each one percent increase in average tips in pick-up zones is associated with a significant decline in the number of trips per month. Therefore, increase in average percent tips in pick-up zones does not make pick-up zones more attractive. Taxi drivers are not attracted to taxi zones with high percent tips. This is why we observe high percent tips in Baisley Park, Queens in Table \@ref(tab:pickup_zone_30). 

### Do passengers pay more tips during rush hours? 
New York City Taxi Fare & Limousine Commission has information on how New York City taxi fare amount is calculated on their [official website](http://www.nyc.gov/html/tlc/html/passenger/taxicab_rate.shtml). 

**Metered Fare Information**
**Onscreen rate is ‘Rate #01 – Standard City Rate.’**
*The initial charge is $2.50.
*Plus 50 cents per 1/5 mile or 50 cents per 60 seconds in slow traffic or when the vehicle is stopped.
*In moving traffic on Manhattan streets, the meter should “click” approximately every four downtown blocks, or one block going cross-town (East-West).
*There is a 50-cent MTA State Surcharge for all trips that end in New York City or Nassau, Suffolk, Westchester, Rockland, Dutchess, Orange or Putnam Counties.
*There is a 30-cent Improvement Surcharge. 
*There is a daily 50-cent surcharge from 8pm to 6am.
*There is a $1 surcharge from 4pm to 8pm on weekdays, excluding holidays.
*Passengers must pay all bridge and tunnel tolls.
*Your receipt will show your total fare including tolls. Please take your receipt.
*The driver is not required to accept bills over $20.
*Please tip your driver for safety and good service.
*There are no charges for extra passengers or bags.

In taxi fare calculation, the only unknown variable is slow-trafice time, and all other variables were collected by the meters installed on each medallion taxi for each trip. It is reasonable to assume that for trips with the same pick-up and drop-off locations, the longer the total slow traffic time is, the longer the trip would take. Taxi drivers are compensated for both the normal-speed trip distance and the time spent in slow-traffice. According to the fare calculation algorithm, in moving traffic on Manhattan streets, the meter should “click” approximately every four downtown blocks, or one block going cross-town (East-West); in slow traffic, the meter should "click" every 60 seconds. Therefore, slow traffic increase the minute per mile ratio. 

New York City has the worst traffic jam, and it has overtaken Miami to be voted the U.S. city with the angriest and most aggressive drivers in 2009, according to a survey on road rage released on Tuesday. Bad traffic also cause slow-traffic, and taxi drivers tend to suck in traffic during rush hours.[@reaney2009] Does minute per mile ratio have an impact on the percent tip that passengers pay? Do passengers compensate taxi drivers more during rush hours? Are passengers sympathetic to taxi drivers for the time they spend in slow traffic?

```{r, message=FALSE, echo=FALSE}
yellow_2017_summary_small <- yellow_2017_summary %>%
  mutate(min_per_mile = avg_duration/avg_dis) %>%
  filter(trips > 30)

min_mile_ratio <- lm(avg_tip ~ min_per_mile, data = yellow_2017_summary_small)
summary(min_mile_ratio)$coef[1:2,]
```
As shown in the regression result, fare per minute ratio has a significant positive impact on percent tip. `min_per_mile` ratio does have an positive impact on percent tips. Since trips with slow traffice can be depicted by high minute per mile ratio, passengers do pay more tips during rush hours. 

