---
author: 'Wencong (Priscilla) Li'
header-includes:
    - \usepackage{setspace}\doublespacing
date: 'May 2018'
institution: 'Smith College'
#division: 'Statistical and Data Sciences'
advisor: 'Benjamin Baumer'
#altadvisor: 'Jordan Crouser'
# Delete line 6 if you only have one advisor
department: 'Statistical and Data Sciences'
degree: 'Bachelor of Arts'
title: 'Tools for Understanding Taxicab and E-Hail Service Use in New York City'
knit: "bookdown::render_book"
site: bookdown::bookdown_site
output: 
  thesisdown::thesis_pdf: default
#  thesisdown::thesis_gitbook: default
#  thesisdown::thesis_word: default
#  thesisdown::thesis_epub: default
# If you are creating a PDF you'll need to write your preliminary content here or
# use code similar to line 20 for the files.  If you are producing in a different
# format than PDF, you can delete or ignore lines 20-31 in this YAML header.
abstract: |
  `r if(knitr:::is_latex_output()) paste(readLines("00-abstract.Rmd"), collapse = '\n  ')`
# If you'd rather include the preliminary content in files instead of inline
# like below, use a command like that for the abstract above.  Note that a tab is 
# needed on the line after the |.
acknowledgements: |
  I would love to thank my thesis advisor Benjamin Baumer, Assistant Professor of Statistical and Data Sciences at Smith College, for encouraging me to challenge myself and guiding me through this project. I want to thank Jordan Crouser for being my second reader and help me to revise my paper. I also want to thank all my friends and my roommates for their love and support. 

bibliography: bib/thesis.bib
# Download your specific bibliography database file and refer to it in the line above.
csl: csl/apa.csl
# Download your specific csl file and refer to it in the line above.
lot: true
lof: true
space_between_paragraphs: true
# Delete the # at the beginning of the previous line if you'd like
# to have a blank new line between each paragraph
#header-includes:
#- \usepackage{tikz}
---

<!--
Above is the YAML (YAML Ain't Markup Language) header that includes a lot of metadata used to produce the document.  Be careful with spacing in this header!

If you'd prefer to not include a Dedication, for example, simply delete lines 17 and 18 above or add a # before them to comment them out.  If you have other LaTeX packages you would like to include, delete the # before header-includes and list the packages after hyphens on new lines.

If you'd like to include a comment that won't be produced in your resulting file enclose it in a block like this.
-->

<!--
If you receive a duplicate label error after knitting, make sure to delete the index.Rmd file and then knit again.
-->

```{r include_packages, include = FALSE}
# This chunk ensures that the thesisdown package is
# installed and loaded. This thesisdown package includes
# the template files for the thesis.
if(!require(devtools))
  install.packages("devtools", repos = "http://cran.rstudio.com")
if(!require(thesisdown))
  devtools::install_github("ismayc/thesisdown")
library(thesisdown)
```

<!-- You'll need to include the order that you'd like Rmd files to appear in the _bookdown.yml file for
PDF files and also delete the # before rmd_files: there.  You'll want to not include 00(two-hyphens)prelim.Rmd
and 00-abstract.Rmd since they are handled in the YAML above differently for the PDF version.
-->

<!-- The {.unnumbered} option here means that the introduction will be "Chapter 0." You can also use {-} for no numbers
on chapters.
-->


<!-- 
If you're still on the fence about using _R Markdown_, check out the resource for newbies available at <https://ismayc.github.io/rbasics-book/> or email us at <data@reed.edu>. 
-->

<!--chapter:end:index.Rmd-->

```{r, message=FALSE, echo=FALSE}
library(knitr)
library(formatR)
opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=FALSE)
```

# Introduction
## Motivation
When is the best time during a day to travel to JKF Airport from Brooklyn? How much tip do passengers usually pay to the taxi drivers? Is the \$52 flat rate from Manhattan to JFK Airport appropriate? Questions about New York City taxicabs are frequently asked by people travelling in taxis in New York City. New York City Taxi and Limousine Commission (TLC) provides taxi trip data on [their website](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml) for people to study and answer these questions. However, it is not easy to work with taxi trip data provided by TLC, because there are more than 250,000 taxi trips happenning everyday in New York City [@emma2017], which implies the large size of the datasets.

Working with medium data, such as the taxi TLC trips records, in **R** is not an easy task. Loading medium-sized data into the **R** environment takes a long time and might crash an **R** session. Creating a user-friendly platform that allows **R** users to easily work with medium data is my motivation. In my study, I focus on New York City taxicab data because there are a lot of interesting questions about New York City taxicabs that I want to explore. 

New York City taxi drivers, passengers, and New York City TLC are the three parties who are closely involved in the New York City taxi industry. Each party has its own needs. Better understanding the needs of the three parties and providing solutions to satisfy their needs is the goal of this thesis.

This work contains two main components. The first component is building the tool to work with the TLC taxi trip data, and the second component is using the tool we build to understand the taxicab and e-hail service use in New York City.

## Background
### Yellow Taxi
NYC Taxicabs are operated by private firms and licensed by the New York City Taxi and Limousine Commission (TLC). TLC issues medallions to taxicabs, and every taxicab must have a medallion to operate. There were 13,437 yellow medallion taxicabs licenses in 2014, and taxi patronage has declined since 2011 because of the competition caused by rideshare services [@wikipediataxi].

### Green Taxi
The apple green taxicabs in New York City are called Boro taxis and they are only allowed to pick up passengers in the outer boroughs and in Manhattan above East 96th and West 110th Streets. Historically, only the yellow medallion taxicabs were allowed to pick up passengers on the street. However, since 95% of yellow taxi pick-ups occurred in Manhattan to the South of 96th Street and at the two airports, the Five Borough Taxi Plan was started to allow green taxis to fill in the gap in outer boroughs in the summer of 2013 [@greentaxi].

### Uber
Uber Technologies Inc. is an American technology company that operates private cars worldwide. Uber drivers use their own cars, instead of corporate-owned vehicles, to drive with Uber.  In NYC, Uber uses 'upfront pricing', meaning that riders are informed about the fares that they will pay before requesting a ride, and gratuity is not required. Riders are given the opportunity to compare different transportation fares before making their decisions on which one to choose. Uber NYC was launched in May 2011 [@ubernyc]. 

### Lyft
Similar to Uber, Lyft is also an on-demand transportation company, and it operates the Lyft car transportation mobile app. Lyft is the main competitor of Uber, and it came into market in July 2014 in New York City [@ubernyc]. 

## Literature Review 
### New York City Traffic and Taxi
New York City is one of the most popular cities in the United States, and New York City taxicabs represent the image of New York City. New York City's traffic is a popular topic in journalism, and different aspects of it has been studied by journalists, such as Patricia Reaney. New York City's traffic is a nightmare, and the city officials have long been trying to solve the congestion problem. In 2009, New York City was voted to be the U.S. city with the "angriest and most aggressive drivers". [@reaney2009] The bad temper of drivers are exacerbated by New York City's severe cogestion. 

How bad is the cogestion? In a journal published by New York Post in 2016, New York City was described as "the city that never moves". [@furfaro2016] What has led to the congestion in the city? A journal from New York Post tried to find an answer to this question: According to a former top NYPD official, "The city streets are being engineered to create traffic congestion, to slow traffic down, to favor bikers and pedestrians" so that drivers will have the incentive to leave their cars at home and turn to mass transit or bicycles [@sugar2017]. 

No matter how miserable the driving experiences are, taxi drivers have no luxury to choose alternative transportation, and instead thay have to consistently drive their cabs, which are usually surrounded by bad traffic, in order to make a living.

### Competition between New York City taxi and e-hail services
```{r totals-by-car-type, fig.cap= "NYC Monthly Taxi Pickups" ,fig.align='center', echo=FALSE}
knitr::include_graphics("figure/totals_by_car_type.png", dpi = 150 )
```

As shown in the visulization above [@schneider2015], the number of New York City yellow taxi trips has been consistently declining for about 4 years, and the numbers of Uber and Lyft trips keep increasing. In 2017, for the first time, the total number of monthly Uber trips exceeded the number of yellow taxi trips. 

Some studies have shown how competitive Uber and Lyft are. In 2017, Uber and Lyft registered vehicles outnumbered NYC yellow cabs by 4 to 1. [@sugar2017] Even though Yellow cab used to be the most popular street-hail transportation service in New York City, passengers nowadays tend to choose the more convenient options, ride-hailing apps.[@hu2017]

As reported in a jounal from Forbes Tech, data scientists from the University of Cambridge in the UK and the University of Namur in Belgium found that yellow taxi rides are on average \$1.40 cheaper than Uber X, which is one type of economy ride service offered by Uber [@uberx]. Moreover, uber appears more expensive for trips that are cheaper than \$35, and less expensive than yellow taxi ride for trips that are more expensive than \$35. Therefore, for short trips, taking a taxi is more affordable. [@guerrini2015]

Apps, such as Openstreetcab, that compares the price of Uber and taxi trips are designed to help customers to compare the fares of different transportations. [@appone]

### etl R package
In `R Markdown: Integrating A Reproducible Analysis Tool into Introductory Statistics`, the authors have presented experimental and statistical evidence that _R Markdown_ replaced the antiquated and hard-to-reproduce `copy-and-paste workflow`, and makes creating fully-reprodicible statistical analysis straight-forward [@baumer2014].

Work with taxi trip data is not an easy task, because of the large size of the taxi trip datasets [@emma2017]. Taxi trip datasets are alssified as 'medium data'. Loading medium-sized data into **R** environment takes a long time and might crush an **R** session. `etl` **R** package creates a user-friendly platform that allows **R** users to easily work with medium data with the extract, transform, load framework, which is commonly konwn as ETL in computing [@wikipedia]. The `ETL` process has been set up [@pkgetl] in **R** to facilitate etl operations for medium data, and it is designed to work with any general data set. Packages that are specific to  perticular data sets are needed to be written in order to better work with complex medium-sized data sets.

## Contribution
### 'nyctaxi' Package
`nyctaxi` is an **R** package that help users to easily get access to New York City Taxi, Uber and Lyft trip data through Extract, Transform, and Load functions (ETL). [@pkgetl] This package facilitates ETL to deal with medium data that are too big to store in memory on a laptop. Users are given the option to choose specific years and months as the input parameters of the three ETL functions, and a connection to a populated SQL database will be returned as the output. Users do not need to learn SQL queries, since all user interaction is in **R**.

```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=FALSE}
library(webshot)
webshot("https://github.com/beanumber/nyctaxi","figure/nyctaxi-page.png", cliprect = c(1425, 0, 1000, 500))
```

```{r, fig.align='center', echo=FALSE}
knitr::include_graphics("figure/nyctaxi-page.png", dpi = 170 )
```

### Social Impact of NYC Taxi
NYC Taxi drivers wants to make the most profit. Taxi passengers want the cheapest and most convenient way of transportantion. Since Uber and Lyft launched their services in New York City, many consumers started to demand the cheaper e-hail services [@sugar2017]. TLC wants to protect both taxi drivers and passengers, and it creates policies to make NYC taxi more accessible to consumers who really need this service. In these sections, we analyze what each party wants and try to find a way for them to be achieve their goals. 

### Reproducible Research
Reproducible research and open source are two main emphasis of this honors project. As scholars place more emphasis on the reproducibility of research studies, it is essential for us to make our data and code openly available for people to redo the analysis. 

`Knitr` and Github are used in my project to make my study reproducible, ranging from the initial source to raw data to the package I wrote to utlize the raw data to the statistical data analysis. I used an **R** package called `thesisdown` to typeset this paper, this tool allows authors to create reproducible and dynamic techinical report in **R** Markdown. It also allows users to embed **R** code and interactive applicationis, and output into PDF, Word, ePub, or gitbook doocuments. `thesisdown` helps users to efficiently put together any paper with similar format.

Github is used to store the scripts for `nyctaxi` and this thesis. `nyctaxi` is available on CRAN for people to download and install [@pkgnyctaxi], and the source code for data analysis in this thesis is available under the Github account of the author so that scholars can easily access the  information that thery are interested in. In terms of tables, figures, and anything included in the Appendix attached to this thesis, scripts that are used to generate them are included in the Github repository.  

<!--chapter:end:00-introduction.Rmd-->

```{r, message=FALSE, echo=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=FALSE)
```

# Data and nyctaxi Package {#chapter2}
## Data and Storage
The `nyctaxi` **R** package allows users to download, clean, and load data into SQL databases. There are four types of data that are available for users to get access to: trip level yellow taxi data from 2009 to the most recent month, trip level green taxi data from August 2013 to the most recent month, Uber pick-up data from April to September 2014 and from Janaury to June 2015, and weekly-aggregated Lyft trip data from 2016 to the most recent week [@pkgnyctaxi].

### Yellow Taxi
The total size of all yellow taxi trip data `csv` files (from Jan 2010 to Dec 2016) is 191.38 GB, and NYC yellow taxi trip data from Jan 2009 to the most recent month can be found on the NYC Taxi & Limousine Commission (TLC) website [@datayellow]. The data were collected and provided to the NYC TLC by technology providers authorized under the Taxicab & Livery Passenger Enhancement Programs (TPEP/LPEP).

The yellow taxi trip records include the following fields: pick-up and drop-off dates/times, pick-up and drop-off locations, trip distances, itemized fares, rate types, payment types, and driver-reported passenger counts. 

### Green Taxi
The total size of green taxi trip data `csv` files (from Aug 2013 to Dec 2016) is 7.8 GB, and green taxi trip data from Aug 2013 to the most recent month can be downloaded from NYC Taxi & Limousine Commission (TLC). [@datayellow] Green taxi trip records include the same variables as yellow taxi trip records.

### TLC Summary Report
The New York City TLC publishes summary reports that include aggregate statistics about taxi, Uber, and Lyft usage. These are in addition to the trip-level data; although the summary reports contain much less detail, they’re updated more frequently, which provides a more current glimpse into the state of the cutthroat NYC taxi market. [@datayellowmonth]

In addition, the trip level NYC Uber data only covers two periods, from April to September 2014 and from January to June 2015. However, the summary reports cover weekly-aggreagated data from 2015 to the most recent week.

```{r, message=FALSE, eval=FALSE, echo=FALSE, eval=FALSE}
webshot("http://www.nyc.gov/html/tlc/html/technology/aggregated_data.shtml","figure/a-report.png", cliprect = "viewport")
```

```{r, fig.align='center', echo=FALSE}
knitr::include_graphics("figure/a-report.png", dpi = 170 )
```

The data can be accessed by using the following commands:

* Yellow taxi data
```{r, eval=FALSE}
download.file("http://www.nyc.gov/html/tlc/downloads/csv/data_reports_monthly_indicators_yellow.csv", destfile = "~/Desktop/yellow_monthly_data.csv")
```

*Uber and Lyft data
```{r, eval=FALSE}
download.file("http://data.cityofnewyork.us/api/views/2v9c-2k7f/rows.csv?accessType=DOWNLOAD", destfile = "~/Desktop/fhv_weekly_data.csv")
```

### Uber
The total size of Uber pick-up data (from Apr to Sep 2014 and from Jan to June 2015) is 900 MB, and thanks to FiveThirtyEight who obtained the data from NYC TLC by submitting a Freedom of Information Law request on July 20, 2015, these data are now open to public. [@datauber]

The 2014 Uber data contains 4 variables: `Date/Time` (the date and time of the Uber pick-up), `Lat` (the latitude of the Uber pick-up), `Lon` (the longitude of the Uber pick-up), and `Base` (the TLC base company code affiliated with the Uber pickup).

The 2015 Uber data contains 4 variables: `Dispatching_base_num` (the TLC base company code of the base that dispatched the Uber), `Pickup_date` (the date of the Uber pick-up), `Affiliated_base_num` (the TLC base company code affiliated with the Uber pickup), and `locationID` (the pick-up location ID affiliated with the Uber pickup).

NYC Open Data also provides weekly-aggreagated Uber pick-up data from 2015 to the most recent month. [@datauberweek]

### Lyft
The total size of weekly-aggregated Lyft trip data (from Jan 2015 to Dec 2016) is 914.9 MB, and these data are open to public and weekly-aggregated Lyft data from 2015 to the most recent week can be found on NYC OpenData website. [@datalyft]

### Data Storage
The total size of all `csv` files of the four services is about 200 GB, and a laptop usually has memory less than or equal to 8 GB. Limited memory constrains the amount of data that can be loaded by a personal computer at one time. When users load data into **R** environment, **R** keeps them in memory; when the amount of data loaded into **R** environment gets close to the limit of a computer’s memory, **R** becomes unresponsive or force quit the current session. Therefore, better ways to work with data that takes more space than 8 GB is needed. According to Zhang (2016), comparing to RAM, hard disk is often used to store medium-sized data, because it is affordable and are designed for storing large items permanently.  However, retrieving data from hard drives is about 1,000,000 times slower.

## ETL nyctaxi Package
`etl` is the parent package of `nyctaxi`. `etl` provides a framework that allows **R** users to work with medium data without any knowledge in SQL database. Users can run SQL queries by using `dplyr` commands in **R** and choose to only return the final result, which could be a summary table, from SQL database into **R** Environment in order to aovid **R** from crashing. The user interaction takes place solely within **R**. 

`etl` framework has three operations -Extract, Transfer, and Load- which bring real-time data into local or remote SQL databases. Users can  specify which type of SQL database they prefer to connect to. `etl`-dependent packages, such as `nyctaxi`, make medium data more accessible to a wider audience. [@baumer2014]

`nyctaxi` was initially designed to work with New York City taxi data, but later on Uber and Lyft data were added and the ETL functions are modified to be specialized in working with these data. This package compiles three major sources of hail service in New York City so that it is convenient for users to compare and contrast the performance of these three services. [@pkgnyctaxi]

This package inherits functions from many packages: `etl`, `dplyr`, `DBI`, `rlang`, and `stringr`. 

Since SQL databases are good tools for medium data analysis, ETL functions build connection to a SQL database at the back end and convert **R** code automatically into SQL queries and send them to the SQL database to get data tables containing data of each hail service. Thus, users do not need to have any knowledge of SQL queries and they can draw in any subsets of the data from the SQL database in **R**.

In general, `etl_extract.etl_nyctaxi()` function download data of the four types of hail service data (yellow taxi, green taxi, Uber, and Lyft) from the corresponding sources. `etl_transform.etl_nyctaxi()` uses different techniques to clean all four types of data to get then ready for the next step. `etl_load.etl_nyctaxi()` loads the data user selected to a SQL database. 
 
The Comprehensive **R** Archive Network (CRAN) is a collection of sites that carry identical material, consisting of the **R** distributions, the contributed extensions, documentation for **R**, and binaries. [@cran] `nyctaxi` **R** package lives on CRAN, and it can be installed with the `install.packages()` function in **R**. 

```{r, eval = FALSE}
install.packages("nyctaxi")
```

```{r, message=FALSE, eval=FALSE, echo=FALSE}
webshot("https://github.com/beanumber/nyctaxi","figure/nyctaxi-page.png", cliprect = c(1425, 0, 1000, 500))
```

```{r, fig.align='center', echo=FALSE}
knitr::include_graphics("figure/nyctaxi-page.png", dpi = 170 )
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
# load packages and data
library(nyctaxi)
library(RMySQL)
library(leaflet)
library(htmlwidgets)
data("taxi_zones")
```

Users need to create an `etl` object in order to apply the etl operations to it, and only the name of the SQL database, working directory, and type of SQL database need to be specified during initialization. If the type of SQL database is not specified, a local RSQLite database will be generated as default. 

```{r, eval = FALSE}
db <- src_mysql("nyctaxi", user = "urname", host = "host", password = "pw")
taxi <- etl("nyctaxi", dir = "~/Desktop/nyctaxi", db)
```

In the example above, a folder called `nyctaxi` is created on the desktop and a connection to a MySQL database is generated. In the procession of initialization, a local folder contains two subfolders, `raw` and `load`, are also created under the directory the user specifies. `raw` folder stores data downloaded from online open sources, and `load` folder stores cleaned CSV data files that are ready to be loaded into SQL database. The ETL framework keeps data directly scraped from online data sources in their original forms. In this way, the original data is always available to users in case data corruption happens in later stages. 

After an etl object is created (nyctaxi is the etl object in this case), four parameters are needed to specify the data that users want: (1) `obj`: an etl object; (2) `years`: a numeric vector giving the years, and the default is the most recent year; (3) `months`: a numeric vector giving the months, and the default is `1:12`; (4) `type`: a character variable giving the type of data the user wants to download. There are four types: `yellow`, `green`, `uber`, and `lyft`. The default is `yellow`.

### Taxi zone shapefile attached to nyctaxi **R** package
Two datasets are attached to `nyctaxi`. The first one is called `taxi_zone_lookup`, and this dataset contains information, such as taxi zone location IDs, location names, and corresponding boroughs for each ID. [@datayellow] A shapefile containing the boundaries for the taxi zones, `taxi_zones`, is also included in the package for users to do spatial analysis. Visulizations similar to one shown below can be generated with the shapefile. 

```{r, message=FALSE, echo=FALSE, eval=FALSE, warning=FALSE}
map <- leaflet(data = taxi_zones) %>%
  addProviderTiles(providers$OpenStreetMap)%>%
  #addTiles() %>%
  addPolygons(fillOpacity = 0.2,
              weight = 1,
              opacity = 0.8) %>%
  setView(lat = 40.7128, lng = -74.0060, zoom = 11)
map
saveWidget(map, file = "zonemap.html")
webshot("zonemap.html","figure/zonemap.png", cliprect = "viewport")
```

```{r zonemap, fig.cap="NYC Taxi Zone Map", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/zonemap.png", dpi = 170 )
```

## Extract-Transform-Load 
### Extract
`etl_extract.etl_nyctaxi()` allows users to download New York City yellow taxi, green taxi, Uber, and Lyft data from the corresponding data sources. It takes the `years`, `months`, and `type` parameters and download the New York City taxi data specified by users. New York City Yellow and Green Taxi data are updated on NYC Taxi & Limousine Commission (TLC) website on a monthly basis. 

```{r, eval=FALSE}
taxi %>% 
   etl_extract(years = 2014:2016, months = 1:12, type = c("yellow", "green"))
```

Uber trip record data is static and small, so we decided to only give users the options to either download all data from April to Sepetember, 2014 or download all Uber trip records from Janaury to June, 2015 at onc. Users do not have the ability to download Uber data from a specific month. 
```{r, eval=FALSE}
taxi %>% 
   etl_extract(years = 2014:2016, months = 1:12, type = c("uber"))
```

Lyft data is updated on NYC Open Data webiste on a weekly basis. Since the weekly-aggregated data is tiny and only data later then 2014 is available, we decided to only allow users to download Lyft data by year. 

```{r, eval=FALSE}
taxi %>% 
   etl_extract(years = 2014:2016, months = 1:12, type = c("lyft"))
```

The default `years` is the current year, and the default `months` are the all twelve months. The default type of transportation is `yellow`. When an invalid month is entered, warning message will suggest users to reconsider their choice and select a new set of month. 

### Transform
`etl_transform.etl_nyctaxi()` allows users to transform New York City yellow taxi, green taxi, Uber, and Lyft data into cleaned formats, and it utlizes different data cleaning techniques when it transforms data for each transportation type. In general, it cleans the data and creates a new `csv` file in the `load` directory to store the cleaned data. It helps us to retain and protect raw data from being modified or destroyed. Users are allowed to specify the month of interest in order to only transform the data that they are interested in. This functionality helps people to be more efficient with their use of time.

By default, it takes the current year Yellow taxi trip records data files, and save copies of them in the `load` diectory. It skips the cleaning step, because the raw Yellow Taxi data downloaded from TLC is already in a desired format with all variables correctly labelled. 

```{r, eval=FALSE}
taxi %>% 
   etl_transform(years = 2014:2016, months = 1:12, type = c("yellow", "green", "uber", "lyft"))
```

There are a few main transformations that are done by this function:

#### Green Taxi -- Extra Blank Row and Column
Green Taxi monthly data from August 2013 to the most recent month besides 2015 all have a blank second row in the `csv` files. Similar to this problem, Green Taxi data from 2013, 2014, and 2015 all have an extra blank columns attanched to the right-most column. These blank rows and columns cause problems in the later stage when users want to load data into SQL database. In order to get Green Taxi data ready for the `load` phase, we used the `system()` function in **R** to invoke the Terminal command specified to remove the blank rows and columns.

#### Uber Data -- Reconciling Inconsistent Filenames
Uber only released over 4.5 million data records from April to September 2014 and 14.3 million records from Janaury to June 2015. Information of different sets of variables are released for 2014 and 2015, and variables have different naming convention. When users want to download data from both years, variables are renamed so that data from both years can be cosolidated into one big dataset with consistent variable names. 

#### Uber Data -- Reconciling Inconsistent Data Formats
The data type of `Date/Time` variable in Uber datasets is originally encoded as `character`. In order to enable it to be recognized as `timestamp` by **R**, we use `ymd_hms` in `lubridate` [@pkglubridate] to transform date time to `POSIXct` objects.

#### Optimizing I/O Process
Improving file input and output processes is an important part of `etl_transform`. `data.table` [@pkgdatatable] only takes half of the time to read from and write into datasets comparing to `readr` [@pkgreadr]. Therefore, `etl_transform` uses `fread()` and `fwrite()` from `data.table` instead of `read_csv` or `write_csv` from `readr` to reduce the data processing time [@zhang2017].

### Load
`etl_load.etl_nyctaxi()` allows users to load New York City yellow taxi, green taxi, Uber, and Lyft data into different data tables in a SQL database. It populates a SQL database with data cleaned by `etl_transform`. 

```{r, eval=FALSE}
taxi %>% 
   etl_load(years = 2014:2016, months = 1:12, type = c("yellow", "green", "uber", "lyft"))
```

### SQL Database Initialization
`init.mysql()` is written under `nyctaxi` to help users to set up five basic table structures for MySQL database. `yellow_old` is created for Yellow Taxi data that are prior to August 2016, and `yellow` is created for data later than July 2016. `green`, `uber`, and `lyft` are also initiated for the three transportations. 

`etl_init()` can be run after a database connection is built to process to process `init.mysql()` to initialize a MySQL database, and default columns with the correct variable names and typed defined will be automatically generated.

```{r, eval=FALSE}
taxi %>%
  etl_init()
```

In order to increase the query speed at the data analysis stage, `KEY`s are created for multiple variables for each transportation. Since there is no variable containing unique value for each observation, no primary variable is needed. Using `KEY`s in data analysis query can speed up the query process. 

Due to the large size of Yellow Taxi datasets, `yellow_old` and `yellow` are partitioned into subgroups by `year`. When we need to run a query on data from a specific year, having partitions allows MySQL to directly find the data specified without filtering on every single row. It speeds up the query process. A `VIEW` called `yellow_old_sum` is also created to generate a summary table for the number of Yellow Taxi trips in each month. 

```{r, fig.cap="MySQL View", fig.align='center', echo=FALSE, echo=FALSE}
knitr::include_graphics("figure/mysql_view.png", dpi = 250 )
```

## New York City Taxicab and E-hail Services Summary
```{r, eval=FALSE, echo=FALSE}
library(data.table)
library(lubridate)
library(zoo)
library(ggplot2)
green <- fread("/Users/priscilla/Desktop/Honors Thesis/mysql/csv sum/green_summary.csv")
yellow <- fread("/Users/priscilla/Desktop/Honors Thesis/mysql/yellow_summary.csv")
yellow_2 <- fread("/Users/priscilla/Desktop/Honors Thesis/mysql/yellow-new_summary.csv")
yellow <- bind_rows(yellow, yellow_2)
download.file("https://data.cityofnewyork.us/resource/gt3n-7ri6.csv?years=2015&$limit=50000", destfile = "/Users/priscilla/Desktop/Honors Thesis/data/uber_weekly_15.csv")
download.file("https://data.cityofnewyork.us/resource/gt3n-7ri6.csv?years=2016&$limit=50000", destfile = "/Users/priscilla/Desktop/Honors Thesis/data/uber_weekly_16.csv")
uber_15_raw <- fread("/Users/priscilla/Desktop/Honors Thesis/data/uber_weekly_15.csv")

uber_15 <- uber_15_raw %>%
  mutate(the_month = substr(`Pickup Start Date`, start = 1, stop = 2)) %>%
  group_by(the_month) %>%
  summarise(num_trips = sum(`Total Dispatched Trips`)) %>%
  mutate(type = "uber",
         the_year = 2015,
         the_month = as.numeric(the_month))
uber_16_raw <- fread("/Users/priscilla/Desktop/Honors Thesis/data/uber_weekly_16.csv")
uber_16 <- uber_16_raw %>%
  mutate(the_month = substr(`Pickup Start Date`, start = 1, stop = 2)) %>%
  group_by(the_month) %>%
  summarise(num_trips = sum(`Total Dispatched Trips`)) %>%
  mutate(type = "uber",
         the_year = 2016,
         the_month = as.numeric(the_month))
uber <- bind_rows(uber_15, uber_16) 
fwrite(uber, "/Users/priscilla/Desktop/Honors Thesis/mysql/csv sum/uber_summary.csv")
lyft <- fread("/Users/priscilla/Desktop/Honors Thesis/mysql/csv sum/lyft_summary.csv")
lyft <- lyft[,2:5]
yellow <- yellow[,2:5]
yellow <- yellow %>% mutate(type = "yellow")
green <- green[,2:5]
combined <- bind_rows(lyft, yellow, green, uber)
combined <- combined %>%
  mutate(the_year = as.character(the_year),
         the_month = as.character(the_month)) %>%
  mutate(date = paste0(the_year, "-", the_month)) %>%
  mutate(date = as.yearmon(date))
num_trips <- ggplot(data = combined, aes(x = date, y = num_trips, colour = type)) +
  geom_line() +
  xlab("Year") +
  ylab("Total Number of Trips") +
  ggtitle("Total Number of Trips Made by Yellow Taxi, Green Taxi, Uber, \n and Lyft from 2014 to 2016") +
  theme(plot.title = element_text(hjust = 0.5))
#save(num_trips,file = "figure/Num_trips_summary.png")
```

```{r num-trips-summary, fig.cap="Summary of Number of trips Made by 4 Types of Transportations between 2014 and 2016 in NYC", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/Num_trips_summary.jpeg", dpi = 130 )
```
Figure \@ref(fig:num-trips-summary) is a summary of total number of trips made by all 4 types of transporations that are available to users from 2014 to 2016. In order to generate this summary, I combined trip-level yellow and green taxi data from TLC trip data website and weekly Uber and Lyft data from NYC OpenData.Data used in Figure \@ref(fig:num-trips-summary) can be accessed by running the code below:

* Yellow taxi monthly data
```{r, eval=FALSE}
download.file("http://www.nyc.gov/html/tlc/downloads/csv/data_reports_monthly_indicators_yellow.csv", destfile = "~/Desktop/yellow_monthly_data.csv")
```

* Uber weekly data
```{r, eval=FALSE}
download.file("https://data.cityofnewyork.us/resource/gt3n-7ri6.csv", destfile = "~/Desktop/uber_weekly_data.csv")
```

* Lyft weekly data
```{r, eval=FALSE}
download.file("https://data.cityofnewyork.us/resource/juxc-sutg.csv", destfile = "~/Desktop/lyft_weekly_data.csv")
```

## Source Code
### ETL Extract
```{r}
etl_extract.etl_nyctaxi <- 
  function(obj, 
years = as.numeric(format(Sys.Date(),'%Y')), 
                                    months = 1:12, 
                                    type  = "yellow",...) {
  #TAXI YELLOW-------------------------
  taxi_yellow <- function(obj, years, months,...) {
    message("Extracting raw yellow taxi data...")
    remote <- etl::valid_year_month(years, months, 
    begin = "2009-01-01") %>%
      mutate_(src = 
  ~file.path("https://s3.amazonaws.com/nyc-tlc/trip+data", 
                               paste0("yellow", "_tripdata_", year, "-",
                      stringr::str_pad(month, 2, "left", "0"), ".csv"))) 
    tryCatch(expr = etl::smart_download(obj, remote$src, ...),
             error = function(e){warning(e)}, 
             finally = warning("Only the following data are availabel on
                                TLC: Yellow taxi data: 2009 Jan - 
                               last month"))} 
  #TAXI GREEN----------------------
  taxi_green <- function(obj, years, months,...) {
    message("Extracting raw green taxi data...")
    remote <- etl::valid_year_month(years, months, begin = "2013-08-01") %>%
      mutate_(src = 
                ~file.path("https://s3.amazonaws.com/nyc-tlc/trip+data", 
                               paste0("green", "_tripdata_", year, "-",
                          stringr::str_pad(month, 2, "left", "0"), ".csv")))
    tryCatch(expr = etl::smart_download(obj, remote$src, ...),
             error = function(e){warning(e)}, 
             finally = warning("Only the following data are availabel on TLC:
                               Green taxi data: 2013 Aug - last month"))} 
  #UBER--------------------------------
  uber <- function(obj, years, months,...) {
    message("Extracting raw uber data...")
    raw_month_2014 <- etl::valid_year_month(years = 2014, months = 4:9)
    raw_month_2015 <- etl::valid_year_month(years = 2015, months = 1:6)
    raw_month <- bind_rows(raw_month_2014, raw_month_2015)
    path = "https://raw.githubusercontent.com/
    fivethirtyeight/uber-tlc-foil-response/master/uber-trip-data"
    remote <- etl::valid_year_month(years, months)
    remote_small <- intersect(raw_month, remote)
    if (2015 %in% remote_small$year && !(2014 %in% remote_small$year)){
      #download 2015 data
      message("Downloading Uber 2015 data...")
      etl::smart_download(obj, "https://github.com/fivethirtyeight/
                          uber-tlc-foil-response/raw/master/
                    uber-trip-data/uber-raw-data-janjune-15.csv.zip",...)}
    else if (2015 %in% remote_small$year && 2014 %in% remote_small$year) {
      #download 2015 data
      message("Downloading Uber 2015 data...")
      etl::smart_download(obj, "https://github.com/fivethirtyeight/
                        uber-tlc-foil-response/raw/master/uber-trip-data
                          /uber-raw-data-janjune-15.csv.zip",...)
      #download 2014 data
      small <- remote_small %>%
        filter_(~year == 2014) %>%
        mutate_(month_abb = ~tolower(month.abb[month]),
                src = ~file.path(path,
                paste0("uber-raw-data-",month_abb,
                substr(year,3,4),".csv")))
      message("Downloading Uber 2014 data...")
      etl::smart_download(obj, small$src,...) 
    } else if (2014 %in% remote_small$year && 
    !(2015 %in% remote_small$year)) {
      message("Downloading Uber 2014 data...")
      #file paths
      small <- remote_small %>%
        mutate_(month_abb = 
                  ~tolower(month.abb[month]),
                src = ~file.path(path,
                paste0("uber-raw-data-",month_abb,
                substr(year,3,4),".csv")))
      etl::smart_download(obj, small$src,...)}
    else {warning("The Uber data you requested are 
                  not currently available. Only data
                  from 2014/04-2014/09 and 2015/01-
                  2015/06 are available...")}
    } 
  #LYFT----------------------------------
  lyft <- function(obj, years, months,...){
    message("Extracting raw lyft data...")
    #check if the week is valid
    valid_months <- etl::valid_year_month(years, months,
    begin = "2015-01-01")
    base_url = "https://data.cityofnewyork.us/
    resource/edp9-qgv4.csv"
    valid_months <- valid_months %>%
      mutate_(new_filenames = 
                ~paste0("lyft-", year, ".csv")) %>%
      mutate_(drop = TRUE)
    #only keep one data set per year
    year <- valid_months[1,1]
    n <- nrow(valid_months)
    for (i in 2:n) {
      if(year == valid_months[i-1,1]) {
        valid_months[i,6] <- FALSE
        year <- valid_months[i+1,1]
      } else {
        valid_months[i,6] <- TRUE
        year <- valid_months[i+1,1]}
      }
    row_to_keep = valid_months$drop
    valid_months <- valid_months[row_to_keep,]
    
    #download lyft files, try two different methods
    first_try<-tryCatch(
      download_nyc_data(obj, base_url, valid_months$year, 
      n = 50000, names = valid_months$new_filenames),
      error = function(e){warning(e)},
      finally = 'method = "libcurl" fails')
  }
  
  if (type == "yellow"){taxi_yellow(obj, years, months,...)} 
  else if (type == "green"){taxi_green(obj, years, months,...)}
  else if (type == "uber"){uber(obj, years, months,...)}
  else if (type == "lyft"){lyft(obj, years, months,...)}
  else {message("The type you chose does not exit...")}
  
  invisible(obj)
}

```


### ETL Transform
```{r}
opts_chunk$set(tidy.opts=list(width.cutoff=60))
etl_transform.etl_nyctaxi <- function(obj, 
                          years = as.numeric(format(Sys.Date(),'%Y')), 
                          months = 1:12, 
                          type  = "yellow",...) {
  #TAXI YELLOW-----------------------------
  taxi_yellow <- function(obj, years, months) {
    message("Transforming yellow taxi data from raw to 
            load directory...")
    #create a df of file path of the files that the user wants to transform
    remote <- etl::valid_year_month(years, months, 
    begin = "2009-01-01") %>%
      mutate_(src = ~file.path(attr(obj, "raw_dir"), 
      paste0("yellow", "_tripdata_", year, "-",
      stringr::str_pad(month, 2, "left", "0"), ".csv"))) 
    #create a df of file path of the files that are in the raw directory
    src <- list.files(attr(obj, "raw_dir"), "yellow", full.names = TRUE)
    src_small <- intersect(src, remote$src)
    #Move the files
    in_raw <- basename(src_small)
    in_load <- basename(list.files(attr(obj, "load_dir"), "yellow", 
    full.names = TRUE))
    file_remian <- setdiff(in_raw,in_load)
    file.copy(file.path(attr(obj, "raw_dir"),file_remian),
              file.path(attr(obj, "load_dir"),file_remian) )}
  #TAXI GREEN-----------------------------
  taxi_green <- function(obj, years, months) {
    message("Transforming green taxi data from raw 
            to load directory...")
    #create a df of file path of the files that the user wants to transform
    remote <- etl::valid_year_month(years, months, 
    begin = "2013-08-01") %>%
      mutate_(src = ~file.path(attr(obj, "raw_dir"), 
      paste0("green", "_tripdata_", year, "-",
      stringr::str_pad(month, 2, "left", "0"), ".csv"))) 
    #create a df of file path of the files that are in the raw directory
    src <- list.files(attr(obj, "raw_dir"), "green", full.names = TRUE)
    src_small <- intersect(src, remote$src)
    #Clean the green taxi data files
    #get rid of 2nd blank row
    if (length(src_small) == 0){
      message("The files you requested are not available 
              in the raw directory.")
    } else{
      #a list of the ones that have a 2nd blank row
      remote_green_1 <- remote %>% filter_(~year != 2015)
      src_small_green_1 <- intersect(src, remote_green_1$src)
      # check that the sys support command line, 
      #and then remove the blank 2nd row
      if(length(src_small_green_1) != 0) {
        if (.Platform$OS.type == "unix"){
          cmds_1 <- paste("sed -i -e '2d'", src_small_green_1)
          lapply(cmds_1, system)
        } else {
          message("Windows system does not 
          currently support removing the 2nd blank row
          in the green taxi datasets. This might affect 
          loading data into SQL...")}
        }else {
          "You did not request for any 
          green taxi data, or all the green
          taxi data you requested are cleaned."}
      #fix column number
      remote_green_2 <- remote %>%
        filter_(~year %in% c(2013, 2014, 2015)) %>%
        mutate_(keep = 
                  ~ifelse(year %in% c(2013,2014), 20,21),
                new_file = 
                  ~paste0("green_tripdata_", year, "_", 
                      stringr::str_pad(month, 2, "left", "0"),
                                   ".csv"))
      src_small_green_2 <- intersect(src, remote_green_2$src)
      src_small_green_2_df <- data.frame(src_small_green_2) 
      names(src_small_green_2_df) <- "src"
      src_small_green_2_df <- inner_join(src_small_green_2_df, 
      remote_green_2, by = "src")
      src_small_green_2_df <- src_small_green_2_df %>%
        mutate(cmds_2 = paste("cut -d, -f1-", keep," ",src, " > ",
        attr(obj, "raw_dir"),"/green_tripdata_", 
        year, "_", stringr::str_pad(month, 2, "left", "0"),".csv", 
        sep = ""))
      #remove the extra column
      if(length(src_small_green_2) != 0) {
        if (.Platform$OS.type == "unix"){
          lapply(src_small_green_2_df$cmds_2, system)} 
        else {
          message("Windows system does not currently 
          support removing the 2nd blank row 
          in the green taxi datasets. This might 
          affect loading data into SQL...")}
        }else {
          "All the green taxi data you
          requested are in cleaned formats."}
      #Find the files paths of the files that need to be transformed
      file.rename(file.path(dirname(src_small_green_2_df$src),
                            src_small_green_2_df$new_file), 
                  file.path(attr(obj, "load_dir"),
                  basename(src_small_green_2_df$src)))
      #Move the files
      in_raw <- basename(src_small)
      in_load <- basename(list.files(attr(obj, "load_dir"), 
      "green", full.names = TRUE))
      file_remian <- setdiff(in_raw,in_load)
      file.copy(file.path(attr(obj, "raw_dir"),file_remian), 
      file.path(attr(obj, "load_dir"),file_remian) )}}
  #UBER--------------------------------
  uber <- function(obj) {
    message("Transforming uber data from raw to load directory...")
    #creat a list of 2014 uber data file directory
    uber14_list <- list.files(path = attr(obj, "raw_dir"), 
    pattern = "14.csv")
    uber14_list <- data.frame(uber14_list)
    uber14_list <- uber14_list %>% mutate_(file_path = 
    ~file.path(attr(obj, "raw_dir"), uber14_list))
    uber14file <- lapply(uber14_list$file_path, readr::read_csv)
    n <- length(uber14file)
    if (n == 1) {
      uber14 <- data.frame(uber14file[1])
    } else if (n == 2) {
      uber14 <- bind_rows(uber14file[1], uber14file[2])
    } else if (n > 2) {
      uber14 <- bind_rows(uber14file[1], uber14file[2])
      for (i in 3:n){uber14 <- bind_rows(uber14, uber14file[i])}
    }
    substrRight <- function(x, n){substr(x, nchar(x)-n+1, nchar(x))}
    uber14_datetime <- uber14 %>%
      mutate(date = gsub( " .*$", "", `Date/Time`), 
      len_date = nchar(date), 
             time = sub('.*\\ ', '', `Date/Time`))
    uber14_datetime <- uber14_datetime %>%
      mutate(month = 
               substr(`Date/Time`, 1, 1),
             day = ifelse(len_date == 8, 
             substr(`Date/Time`, 3,3),substr(`Date/Time`, 3,4)),
             pickup_date = 
               lubridate::ymd_hms(paste0("2014-", month, "-", 
                                         day, " ", time)))
    uber14_df <- uber14_datetime[-c(1,5:9)]
    
    #2015
    zipped_uberfileURL <- file.path(attr(obj, "raw_dir"),
    "uber-raw-data-janjune-15.csv.zip")
    raw_month_2015 <- etl::valid_year_month(years = 2015, months = 1:6)
    remote_2015 <- etl::valid_year_month(years, months)
    remote_small_2015 <- inner_join(raw_month_2015, remote_2015)
    if(file.exists(zipped_uberfileURL) && 
       nrow(remote_small_2015) != 0){
      utils::unzip(zipfile = zipped_uberfileURL,unzip = "internal",
      exdir = file.path(tempdir(), "uber-raw-data-janjune-15.csv.zip"))
      uber15 <- readr::read_csv(file.path(tempdir(),
      "uber-raw-data-janjune-15.csv.zip",
      "uber-raw-data-janjune-15.csv"))}
    
    names(uber14_df) <- c("lat", "lon", "affiliated_base_num", 
    "pickup_date")
    names(uber15) <- tolower(names(uber15))
    uber <- bind_rows(uber14_df, uber15)
    utils::write.csv(uber, file.path(tempdir() ,"uber.csv"))
    if(nrow(uber) != 0) {
      if (.Platform$OS.type == "unix"){cmds_3 <- 
      paste("cut -d, -f2-7",file.path(tempdir(),"uber.csv"), " > ", 
      file.path(attr(obj, "load_dir"),"uber.csv"))
        lapply(cmds_3, system)
      } else {
        message("Windows system does not currently 
        support removing the 2nd blank row 
        in the green taxi datasets. This might
        affect loading data into SQL...")}
      }else {
        "You did not request for any 
        green taxi data, or all the green 
        taxi data you requested are cleaned."}
    }
  #LYFT--------------------------------
  lyft <- function(obj, years, months){
    valid_months <- etl::valid_year_month(years, months = 1, 
    begin = "2015-01-01")
    message("Transforming lyft data from raw to load directory...")
    src <- list.files(attr(obj, "raw_dir"), "lyft", full.names = TRUE)
    src_year <- valid_months %>% distinct_(~year)
    remote <- data_frame(src)
    remote <- remote %>%
      mutate_(lcl = ~file.path(attr(obj, "load_dir"),basename(src)),
              basename = ~basename(src), year = ~substr(basename,6,9))
    class(remote$year) <- "numeric"
    remote <- inner_join(remote,src_year, by = "year" )
    for(i in 1:nrow(remote)) {
        datafile <- readr::read_csv(remote$src[i])
        readr::write_delim(datafile, path = remote$lcl[i], 
        delim = "|", na = "")}}
  
  #transform the data from raw to load
  if (type == "yellow"){taxi_yellow(obj, years, months)} 
  else if (type == "green"){taxi_green(obj, years, months)}
  else if (type == "uber"){uber(obj)}
  else if (type == "lyft"){lyft(obj, years, months)}
  else {message("The type you chose does not exit...")}
  
  invisible(obj)
}

```

### ETL Load
```{r}
opts_chunk$set(tidy.opts=list(width.cutoff=60))
etl_load.etl_nyctaxi <- function(obj, 
 years = as.numeric(format(Sys.Date(),'%Y')), 
                                 months = 1:12, 
                                 type  = "yellow", ...) {
  #TAXI YELLOW-----------------------------
  taxi_yellow <- function(obj, years, months,...) {
    #create a df of file path of the files that are in the load directory
    src <- list.files(attr(obj, "load_dir"), "yellow", 
    full.names = TRUE)
    src <- data.frame(src)
    
    #files before 2016-07
    remote_old <- etl::valid_year_month(years, months, 
    begin = "2009-01-01", end = "2016-06-30") %>%
      mutate_(src = ~file.path(attr(obj, "load_dir"), 
      paste0("yellow", "_tripdata_", year, "-",
      stringr::str_pad(month, 2, "left", "0"), ".csv"))) 
    src_small_old <- inner_join(remote_old, src, by = "src")
    #files later then 2017-06
    remote_new <- etl::valid_year_month(years, months, 
    begin = "2016-07-01") %>%
      mutate_(src =  ~file.path(attr(obj, "load_dir"), 
      paste0("yellow", "_tripdata_", year, "-",
      stringr::str_pad(month, 2, "left", "0"), ".csv"))) 
    src_small_new <- inner_join(remote_new, src, by = "src")
    #data earlier than 2016-07
    if(nrow(src_small_old) == 0) {
      message("The taxi files (earlier than 2016-07) 
              you requested are not available in 
              the load directory...")
    } else {
      message("Loading taxi data from 
              load directory to a sql database...")
      mapply(DBI::dbWriteTable, 
             name = "yellow_old", value = src_small_old$src, 
             MoreArgs = 
               list(conn = obj$con, append = TRUE))}
    
    #data later then 2016-06
    if(nrow(src_small_new) == 0) {
      message("The new taxi files (later than 2016-06) 
              you requested are not available in the 
              load directory...")
    } else {
      message("Loading taxi data from load 
              directory to a sql database...")
      mapply(DBI::dbWriteTable, 
             name = "yellow", value = src_small_new$src, 
             MoreArgs = 
               list(conn = obj$con, append = TRUE))}
    
    }
  #TAXI GREEN----------------------------
  taxi_green <- function(obj, years, months,...) {
    #create a list of file that the user wants to load
    remote <- etl::valid_year_month(years, months, 
    begin = "2013-08-01") %>%
      mutate_(src = ~file.path(attr(obj, "load_dir"), 
      paste0("green", "_tripdata_", year, "-",
      stringr::str_pad(month, 2, "left", "0"), ".csv")))
    #create a df of file path of the files that are in the load directory
    src <- list.files(attr(obj, "load_dir"), "tripdata", 
    full.names = TRUE)
    src <- data.frame(src)
    #only keep the files thst the user wants to transform
    src_small <- inner_join(remote, src, by = "src")
    if(nrow(src_small) == 0) {
      message("The taxi files you requested 
              are not available in the 
              load directory...")
    } else {
      message("Loading taxi data from 
              load directory to a sql database...")
      mapply(DBI::dbWriteTable, 
             name = "green", value = src_small$src, 
             MoreArgs = 
               list(conn = obj$con, append = TRUE, ... = ...))}}
  #UBER--------------------------------
  uber <- function(obj,...) {
    uberfileURL <- file.path(attr(obj, "load_dir"), "uber.csv")
    if(file.exists(uberfileURL)) {
      message("Loading uber data from 
              load directory to a sql database...")
      DBI::dbWriteTable(conn = obj$con, name = "uber", 
      value = uberfileURL, append = TRUE, ... = ...)
    } else {
      message("There is no uber data 
              in the load directory...")}}
  #LYFT---------------------------------
  lyft <- function(obj, years, months,...){
    message("Loading lyft data from 
            load directory to a sql database...")
    #create a list of file that the user wants to load
    valid_months <- etl::valid_year_month(years, months, 
    begin = "2015-01-01")
    src <- list.files(attr(obj, "load_dir"), "lyft", 
    full.names = TRUE)
    src_year <- valid_months %>% distinct_(~year)
    remote <- data_frame(src)
    remote <- remote %>% mutate_(tablename = ~"lyft", 
    year =~substr(basename(src),6,9))
    class(remote$year) <- "numeric"
    remote <- inner_join(remote,src_year, by = "year" )
    if(nrow(remote) != 0) {
      write_data <- function(...) {
        lapply(remote$src, FUN = DBI::dbWriteTable, 
        conn = obj$con, name = "lyft", append = TRUE, 
        sep = "|", ... = ...)}
      write_data(...)
    } else {
      message("The lyft files you requested 
              are not available in the 
              load directory...")}}
  
  if (type == "yellow"){taxi_yellow(obj, years, months,...)
  }else if (type == "green"){taxi_green(obj, years, months,...)
  }else if (type == "uber"){uber(obj,...)
  }else if (type == "lyft"){lyft(obj, years, months,...)
  }else {message("The type you chose does not exit...")
            }
  
  invisible(obj)
}

```

### ETL Init

```
DROP TABLE IF EXISTS `yellow_old`;

CREATE TABLE `yellow_old` (
 `VendorID` tinyint DEFAULT NULL,
 `tpep_pickup_datetime` DATETIME NOT NULL,
 `tpep_dropoff_datetime` DATETIME NOT NULL,
 `passenger_count` tinyint DEFAULT NULL,
 `trip_distance` float(10,2) DEFAULT NULL,
 `pickup_longitude` double(7,5) DEFAULT NULL,
 `pickup_latitude` double(7,5) DEFAULT NULL,
 `RatecodeID` tinyint DEFAULT NULL,
 `store_and_fwd_flag` varchar(10) COLLATE latin1_general_ci DEFAULT NULL,
 `dropoff_longitude` double(7,5) DEFAULT NULL,
 `dropoff_latitude` double(7,5) DEFAULT NULL,
 `payment_type` tinyint DEFAULT NULL,
 `fare_amount` decimal(5,3) DEFAULT NULL,
 `extra` decimal(5,3) DEFAULT NULL,
 `mta_tax` decimal(5,3) DEFAULT NULL,
 `tip_amount` decimal(5,3) DEFAULT NULL,
 `tolls_amount` decimal(5,3) DEFAULT NULL,
 `improvement_surcharge` decimal(5,3) DEFAULT NULL,
 `total_amount` decimal(5,3) DEFAULT NULL,
 KEY `VendorID` (`VendorID`),
 KEY `pickup_datetime` (`tpep_pickup_datetime`),
 KEY `dropoff_datetime` (`tpep_dropoff_datetime`),
 KEY `pickup_longitude` (`pickup_longitude`),
 KEY `pickup_latitude` (`pickup_latitude`),
 KEY `dropoff_longitude` (`dropoff_longitude`),
 KEY `dropoff_latitude` (`dropoff_latitude`)
)
PARTITION BY RANGE( YEAR(tpep_pickup_datetime) ) (
  PARTITION p09 VALUES LESS THAN (2010),
  PARTITION p10 VALUES LESS THAN (2011),
  PARTITION p11 VALUES LESS THAN (2012),
  PARTITION p12 VALUES LESS THAN (2013),
  PARTITION p13 VALUES LESS THAN (2014),
  PARTITION p14 VALUES LESS THAN (2015),
  PARTITION p15 VALUES LESS THAN (2016),
  PARTITION p16 VALUES LESS THAN (2017)
);

DROP TABLE IF EXISTS `yellow`;

CREATE TABLE `yellow` (
 `VendorID` tinyint DEFAULT NULL,
 `tpep_pickup_datetime` DATETIME NOT NULL,
 `tpep_dropoff_datetime` DATETIME NOT NULL,
 `passenger_count` tinyint DEFAULT NULL,
 `trip_distance` float(10,2) DEFAULT NULL,
 `RatecodeID` tinyint DEFAULT NULL,
 `store_and_fwd_flag` varchar(10) COLLATE latin1_general_ci DEFAULT NULL,
 `PULocationID` tinyint DEFAULT NULL,
 `DOLocationID` tinyint DEFAULT NULL,
 `payment_type` tinyint DEFAULT NULL,
 `fare_amount` decimal(5,3) DEFAULT NULL,
 `extra` decimal(5,3) DEFAULT NULL,
 `mta_tax` decimal(5,3) DEFAULT NULL,
 `tip_amount` decimal(5,3) DEFAULT NULL,
 `tolls_amount` decimal(5,3) DEFAULT NULL,
 `improvement_surcharge` decimal(5,3) DEFAULT NULL,
 `total_amount` decimal(5,3) DEFAULT NULL,
 KEY `VendorID` (`VendorID`),
 KEY `pickup_datetime` (`tpep_pickup_datetime`),
 KEY `dropoff_datetime` (`tpep_dropoff_datetime`),
 KEY `PULocationID` (`PULocationID`),
 KEY `DOLocationID` (`DOLocationID`)
)
PARTITION BY RANGE( YEAR(tpep_pickup_datetime) ) (
  PARTITION p16 VALUES LESS THAN (2017),
  PARTITION p17 VALUES LESS THAN (2018)
);


DROP TABLE IF EXISTS `green`;

CREATE TABLE `green` (
 `VendorID` tinyint DEFAULT NULL,
 `lpep_pickup_datetime` DATETIME NOT NULL,
 `Lpep_dropoff_datetime` DATETIME NOT NULL,
 `Store_and_fwd_flag` varchar(10) COLLATE latin1_general_ci DEFAULT NULL,
 `RatecodeID` tinyint DEFAULT NULL,
 `Pickup_longitude` double(7,5) DEFAULT NULL,
 `Pickup_latitude` double(7,5) DEFAULT NULL,
 `Dropoff_longitude` double(7,5) DEFAULT NULL,
 `Dropoff_latitude` double(7,5) DEFAULT NULL,
 `Passenger_count` tinyint DEFAULT NULL,
 `Trip_distance` float(10,2) DEFAULT NULL,
 `Fare_amount` decimal(5,3) DEFAULT NULL,
 `Extra` decimal(5,3) DEFAULT NULL,
 `MTA_tax` decimal(5,3) DEFAULT NULL,
 `Tip_amount` decimal(5,3) DEFAULT NULL,
 `Tolls_amount` decimal(5,3) DEFAULT NULL,
 `improvement_surcharge` decimal(5,3) DEFAULT NULL,
 `Total_amount` decimal(5,3) DEFAULT NULL,
 `Payment_type` tinyint DEFAULT NULL,
 `Trip_type` tinyint DEFAULT NULL,
 KEY `VendorID` (`VendorID`),
 KEY `pickup_datetime` (`lpep_pickup_datetime`),
 KEY `dropoff_datetime` (`Lpep_dropoff_datetime`)
);


DROP TABLE IF EXISTS `lyft`;

CREATE TABLE `lyft` (
 `base_license_number` varchar(15) COLLATE latin1_general_ci DEFAULT NULL,
 `base_name` varchar(40) COLLATE latin1_general_ci DEFAULT NULL,
 `dba` varchar(40) COLLATE latin1_general_ci DEFAULT NULL,
 `pickup_end_date` DATE NOT NULL,
 `pickup_start_date` DATE NOT NULL,
 `total_dispatched_trips` smallint DEFAULT NULL,
 `unique_dispatched_vehicle` smallint DEFAULT NULL,
 `wave_number` tinyint DEFAULT NULL,
 `week_number` tinyint DEFAULT NULL,
 `years` smallint DEFAULT NULL,
 KEY `base_name` (`base_name`),
 KEY `pickup_end_date` (`pickup_end_date`),
 KEY `pickup_start_date` (`pickup_start_date`)
);


DROP TABLE IF EXISTS `uber`;

CREATE TABLE `uber` (
 `lat` double(7,5) DEFAULT NULL,
 `lon` double(7,5) DEFAULT NULL,
 `dispatching_base_num` varchar(15) COLLATE latin1_general_ci DEFAULT NULL,
 `pickup_date` DATETIME NOT NULL,
 `affiliated_base_num` varchar(15) COLLATE latin1_general_ci DEFAULT NULL,
 `locationid` tinyint DEFAULT NULL,
 KEY `pickup_date` (`pickup_date`),
 KEY `locationid` (`locationid`)
);

CREATE VIEW yellow_old_sum AS SELECT YEAR(tpep_pickup_datetime) as the_year, MONTH(tpep_pickup_datetime) AS the_month, count(*) AS num_trips
  FROM yellow_old
  GROUP BY the_year, the_month; 
); 
```

<!--chapter:end:01-chap2.Rmd-->

```{r, message=FALSE, echo=FALSE}
opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=FALSE)
```

# New York City Taxi Driver {#chapter3}

The income of Taxi drivers in New York City has two parts: taxi fare and tips. Taxi fare is usually calculated by the meters installed in the taxis, and the rate of fare cannot be changed by taxi drivers. Therefore, in order to make more profit, taxi drivers prefer to pick up passengers who offer big amount of tips. What are the regions that provide the most tips to yellow taxicab drivers?

In the following analysis, we will focus on trip data collected in 2017. Taxi drivers usually do not correctly record the amount of tips paid by cash or check [@foirequest]. Therefore, in order to find out the regions that offer the most tips, we need to filter out the trips that are not paid by credit or debit card.

```{r, message=FALSE, echo=FALSE, eval=FALSE}
library(dplyr)
library(stringr)
library(etl)
library(htmlwidgets)
library(webshot)
library(sp)
data("taxi_zone_lookup")
data("taxi_zones")
```

```{r, echo=FALSE, eval=FALSE}
db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)
```

As mentioned in the previous chapter, that we can utlize the connection to a MySQL database to run data analysis in MySQL for medium-sized data.
Since we are using all 12 month data from 2017 in this analysis, it is impractical to load all data needed into **R** environment. Instead, we want to only load a fraction of the 2017 Yellow Taxi data from MySQL database. 

In this section, we only want to load trip records with payment type equals to 1, which represents credit card. Only trip records with payment type credit card have accurate information on tip amount. Let's load the 2017 trip record into **R** environment by using the MySQL connection we just generated, `taxi`.
```{r, eval=FALSE}
yellow_2017 <- taxi %>%
  tbl("yellow") %>%
  filter(payment_type == 1) %>%
  collect(n = Inf)
```

```{r, echo=FALSE, message=FALSE, eval=FALSE}
#second half
yellow_2017_2 <- taxi %>%
  tbl("yellow") %>%
  filter(payment_type == 1) %>%
  filter(month(tpep_pickup_datetime) > 6) %>%
  collect(n = Inf)

yellow_2017_summary_2 <- yellow_2017_2 %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(duration = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2) ) %>%
  mutate(duration = as.numeric(duration)) %>%
  filter(duration > 0) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 0) %>%
  filter(payment_type ==1 | payment_type == 2) %>%
  mutate(year = year(tpep_pickup_datetime),
         month = month(tpep_pickup_datetime),
         tip_perct = tip_amount/fare_amount) %>%
  group_by(year, month, PULocationID, DOLocationID) %>%
  summarise(avg_tip = mean(tip_perct), 
            trips = n(),
            avg_dis = mean(trip_distance),
            avg_duration = mean(duration))

db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)

#first half
yellow_2017_1 <- taxi %>%
  tbl("yellow") %>%
  filter(payment_type == 1) %>%
  filter(month(tpep_pickup_datetime) < 7) %>%
  collect(n = Inf)

yellow_2017_summary_1 <- yellow_2017_1 %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(duration = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2) ) %>%
  mutate(duration = as.numeric(duration)) %>%
  filter(duration > 0) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 0) %>%
  filter(payment_type ==1 | payment_type == 2) %>%
  mutate(year = year(tpep_pickup_datetime),
         month = month(tpep_pickup_datetime),
         tip_perct = tip_amount/fare_amount) %>%
  group_by(year, month, PULocationID, DOLocationID) %>%
  summarise(avg_tip = mean(tip_perct), 
            trips = n(),
            avg_dis = mean(trip_distance),
            avg_duration = mean(duration))

#Combine summary_2 and summary_1
yellow_2017_summary <- bind_rows(yellow_2017_summary_1, yellow_2017_summary_2)
```

## Aggregated Zone-level Tip Information
Instead of the absolute amount of tips, we want to focus on the percentage of tips that passengers pay in addition to the total fare amount. Therefore, we use tip amount over fare amount to calculate the percent tip. We then calculated the mean percent tip, mean distances travelled, mean number of minutes spent travelling, and total number of trips of each pick-up and drop-off pair in 2017 to get the aggregated zone-level information in order to compare the percent tip passengers pay in each zone. 

```{r, eval=FALSE}
yellow_2017_summary <- yellow_2017 %>%
  mutate(year = year(tpep_pickup_datetime),
         month = month(tpep_pickup_datetime),
         tip_perct = tip_amount/fare_amount) %>%
  group_by(year, month, PULocationID, DOLocationID) %>%
  summarise(avg_tip = mean(tip_perct), 
            trips = n(),
            avg_dis = mean(trip_distance),
            avg_duration = mean(duration))
```


```{r, eval=FALSE, echo=FALSE}
yellow_2017_summary <- yellow_2017 %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(duration = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2) ) %>%
  mutate(duration = as.numeric(duration)) %>%
  filter(duration > 0) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  mutate(year = year(tpep_pickup_datetime),
         month = month(tpep_pickup_datetime),
         tip_perct = tip_amount/fare_amount) %>%
  group_by(year, month, PULocationID, DOLocationID) %>%
  summarise(avg_tip = mean(tip_perct), 
            trips = n(),
            avg_dis = mean(trip_distance),
            avg_duration = mean(duration))
```

```{r, echo=FALSE, eval=FALSE}
fwrite(yellow_2017_summary, "/Users/priscilla/Desktop/Honors Thesis/data/yellow_2017_summary.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
data(taxi_zone_lookup)
yellow_2017_summary <- data.table::fread("/Users/priscilla/Desktop/Honors Thesis/data/yellow_2017_summary.csv")
```

Each taxi trip has pick-up and drop-off locations associated with it, and there are 263 known taxi zones. 
```{r, echo=FALSE, message=FALSE, warning=FALSE}
tip_region <- yellow_2017_summary %>%
  rename(LocationID = PULocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(PULocationID = LocationID) %>%
  arrange(year, month, desc(avg_tip)) %>%
  rename(LocationID = DOLocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(DOLocationID = LocationID) %>%
  arrange(year, month, desc(avg_tip)) %>%
  filter(Zone.x != "Unknown") %>%
  filter(Zone.y != "Unknown")
```

```{r tip-region, fig.cap="Percent Tip Paid by Passengers on Each Pick-up And Drop-off Pair in NYC", echo=FALSE, message=FALSE, warning=FALSE}
region_vis <- ggplot(data = tip_region, aes(x = avg_tip) ) +
  xlab("Percent Tip") +
  ylab("Count") +
  geom_histogram(binwidth = 0.005) + 
  geom_vline(xintercept = c(0.20), col = "red",linetype = "longdash") +
  geom_vline(xintercept = c(0.25), col = "green",linetype = "longdash") +
  geom_vline(xintercept = c(0.28), col = "yellow",linetype = "longdash") + 
  scale_x_continuous(limits = c(0, 0.5))
region_vis
```
Figure \@ref(fig:tip-region) is a histogram of mean tip percents for all known pick-up and drop-off zone pairs.

### Pick-up Zone Tip Information
Taxi drivers are required to be indifferent to where passengers are going. Therefore, it makes sense to investigate the average amount of tips paid for each pick-up zone. What are the taxi pick-up zones that have the highest tip percents?

We first calculate the average percent tip paid for each pick-up zone. 
```{r, message=FALSE, echo=FALSE}
tip_pickup <- yellow_2017_summary %>%
  group_by(year, month, PULocationID) %>%
  summarise(avg_tip = round(mean(avg_tip), 2), 
            num_trips=sum(trips),
            avg_dis = round(mean(avg_dis),2),
            avg_duration = round(mean(avg_duration),2)) %>%
  rename(LocationID = PULocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(PULocationID = LocationID) %>%
  arrange(year, month, desc(avg_tip)) %>%
  filter(Zone != "Unknown")
```

```{r, message=FALSE, echo=FALSE}
tip_pickup_1 <- tip_pickup %>%
  filter(num_trips > 10)
kable(tip_pickup_1[1:10,4:9], caption = "Ten taxi pick-up zones with the highest average tip in January, 2017", booktabs = TRUE)
```
Table \@ref(tab:tip_pickup_1) is a list of pick-up zones with their average percent tip.

We created a histogram to visualize the distribution of average percent tips paid for all pick-up zones. 
```{r pickup-vis, fig.cap = "Percent Tip Paid by Passengers on Each Pick-up Taxi Zone in NYC", echo=FALSE, message=FALSE, warning=FALSE}
pickup_vis <- region_vis %+% tip_pickup
pickup_vis
```
As show in Figure \@ref(fig:pickup-vis), the first peak is around 20%, which is the cheapest default option on the touch panel for passengers to chose. 

**Does trip distance increase the percent tips paid?** 
One of the questions that I always wonder is whether longer trips result in higher tip percent. It takes taxi drivers more time to complete longer trips, so passengers might want to compensate taxi drivers more. I personally pay higher percent of tips for longer rides, so I believe trip distance has an impact on percentage of tips paid.

```{r, echo=FALSE}
tip_distance <- lm(avg_tip ~ avg_dis + PULocationID + DOLocationID, data = tip_region)
summary(tip_distance)$coef[1:2,]
```
Acoording to the simple linear regression result, trip distance does have a negative significant impact on the percent of tips paid, controlling for both pick-up and drop-off locations. This could be caused by a psycological reason. Long trips cost more than short trips. For a constant tip percent, the absolute value of tip amount cost more for longer trips. For example, for a \$100 trip, 20% tip costs \$20; for a \$50 trip, 20% tip costs \$10. Even though consumers are paying the same percent amount of tips, \$20 is more expensive than \$10. Therefore, consumers might decide to pay less percent tip for longer trips.

### Which taxi zones have the highest number of pick-ups?
Let's fist take a look at which pick-up zones have the highest number of pick-ups. 

```{r, message=FALSE, echo=FALSE}
tip_pickup_zone <- tip_pickup %>%
  group_by(PULocationID) %>%
  summarise(avg_tip = round(mean(avg_tip), 2), 
            num_trips=sum(num_trips),
            avg_dis = round(mean(avg_dis),2),
            avg_duration = round(mean(avg_duration),2)) %>%
  rename(LocationID = PULocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(PULocationID = LocationID) %>%
  arrange(desc(num_trips))

pick_up_zones <- merge(taxi_zones, tip_pickup_zone, by.x = "LocationID", by.y = "PULocationID")
```

We can create a heat map to visulizae the number of trip for each pick-up zones on a map of New York City Taxi Zones.
```{r, echo=FALSE, eval=FALSE}
reds = colorNumeric("Reds", domain = NULL)
#create visulization
num_trip <- leaflet(data = pick_up_zones) %>%
  addProviderTiles(providers$OpenStreetMap)%>%
  addPolygons(fillColor = ~reds(num_trips),
              fillOpacity = 0.6,
              weight = 1,
              opacity = 0.2) %>%
  setView(lat = 40.7128, lng = -74.0060, zoom = 11)

saveWidget(num_trip, file = "/Users/priscilla/Desktop/Honors Thesis/figure/num_trip.html")
URL <- "/Users/priscilla/Desktop/Honors Thesis/figure/num_trip.html"
webshot(URL, "figure/num_trip.png", cliprect = "viewport")
```

```{r num-trip, fig.cap="Number of Pick-ups in Each Taxi Zone", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/num_trip.png", dpi = 200 )
```
According to Figure \@ref(fig:num-trip), It's obvious that Upper East Side Manhattan, Midtown Manhattan, and La Guardia Airport are the most popular location for pick-ups.

```{r, message=FALSE, echo=FALSE}
kable(tip_pickup_zone[1:10,2:7], caption = "Ten taxi zones with the highest number of pick-ups")
```
Table \@ref(tab:tip_pickup_zone) gives you a better idea of which taxi zones have the highest number of pick-ups.

### Which taxi zones have the highest percent tips? 
Most yellow cab pick-ups occur in Manhattan. If we focus on the pick-up zones that have at least 30 trips per day or 10950 per year, we will observe that many taxi pick-up zones with highest percent tips are not necessarily the ones with the highest number of pick-ups. 
```{r}
#pick a threshold for the cutoff number of trips
pickup_zone_30 <- tip_pickup_zone %>%
  filter(num_trips >= (30*365)) %>%
  arrange(desc(avg_tip))
```

```{r, echo=FALSE}
kable(pickup_zone_30[1:10, 2:7], caption = "Ten taxi pick-up zones with the highest percent tip (taxi zones has at least 30 pick-up per day)")
```
People might think it is more reasonable to ses a list that is populated with Zones in Manhattan, since that's where all the wealthy people live. However, Table \@ref(tab:pickup_zone_30) shows that passengers who get on taxis from certain zones in Brooklyn and Queens also pay a lot of tips. Taxi drivers who would love to get more tips compensation can drive to the zones listed above to pick-up passengers.

If we focus on the pick-up zones that have more than 3000 trips per day, then we observe that all pick-up zones that have the highest percent tips are in Manhattan besides La Guardia Airport.
```{r}
pickup_zone_3000 <- tip_pickup_zone %>%
  filter(num_trips >= (365*3000)) %>%
  arrange(desc(avg_tip))
```

```{r pickup_zone_3000, fig.cap = "Ten taxi pick-up zones with the highest percent tip  (taxi zones has at least 3000 pick-up per day)", echo=FALSE}
kable(pickup_zone_3000[1:10,2:7])
```
There are more than 100 times more yellow cab pick-ups that happen in Manhattan everyday than in Brooklyn. By comparing the average tip percent in Table \@ref(tab:pickup_zone_30) and Table \@ref(tab:pickup_zone_3000), we can observe that percent tips paid in taxi zones with low pick-up numbers seem to be higher than percent tips paid in taxi zones with high pick-up numbers. 

## What features of taxi trips are attractive to taxi drivers?
So far, we have learned what pick-up zones offer the highest percent tip. Now, we want to dig into the relationships between percent tip and taxi-zone-specific variables. 

### Do taxi drivers tend to go to zones that offer high tips?
It is not easy to find an available taxi on the street on New York City, because the demand for taxi trips is much higher than the supply. Does paying high percent tips help customers to attract more taxis? 
If customers from certain regions keep paying higher tips, taxi drivers might be able to learn from their experiences in those regions, and be willing to wonder around those regions more often and pick up passengers. Pick-up zones with higher tips should attract more taxi drivers with the control of taxi zones. However, conflivting to what I assumed, Table \@ref(tab:pickup_zone_30) and Table \@ref(tab:pickup_zone_3000) show that percent tips seem to have a inverse relationship with number of pick-ups. 

Let's test the relationship between number of trips and average percent tips in each pick-up zone:
```{r, echo=FALSE}
tip_pickup$PULocationID <- as.character(tip_pickup$PULocationID)
tip_pickup$month <- as.character(tip_pickup$month)
tip_and_trip_1 <- lm(num_trips ~ avg_tip + month, data = tip_pickup)
summary(tip_and_trip_1)$coef[1:2,]
```
Each one percent increase in average tips in pick-up zones is associated with a significant decline in the number of trips per month. Therefore, increase in average percent tips in pick-up zones does not make pick-up zones more attractive. Taxi drivers are not attracted to taxi zones with high percent tips. This is why we observe high percent tips in Baisley Park, Queens in Table \@ref(tab:pickup_zone_30). 

### Do passengers pay more tips during rush hours? 
New York City Taxi Fare & Limousine Commission has information on how New York City taxi fare amount is calculated on their [official website](http://www.nyc.gov/html/tlc/html/passenger/taxicab_rate.shtml). 

**Metered Fare Information**
**Onscreen rate is ‘Rate #01 – Standard City Rate.’**
*The initial charge is $2.50.
*Plus 50 cents per 1/5 mile or 50 cents per 60 seconds in slow traffic or when the vehicle is stopped.
*In moving traffic on Manhattan streets, the meter should “click” approximately every four downtown blocks, or one block going cross-town (East-West).
*There is a 50-cent MTA State Surcharge for all trips that end in New York City or Nassau, Suffolk, Westchester, Rockland, Dutchess, Orange or Putnam Counties.
*There is a 30-cent Improvement Surcharge. 
*There is a daily 50-cent surcharge from 8pm to 6am.
*There is a $1 surcharge from 4pm to 8pm on weekdays, excluding holidays.
*Passengers must pay all bridge and tunnel tolls.
*Your receipt will show your total fare including tolls. Please take your receipt.
*The driver is not required to accept bills over $20.
*Please tip your driver for safety and good service.
*There are no charges for extra passengers or bags.

In taxi fare calculation, the only unknown variable is slow-trafice time, and all other variables were collected by the meters installed on each medallion taxi for each trip. It is reasonable to assume that for trips with the same pick-up and drop-off locations, the longer the total slow traffic time is, the longer the trip would take. Taxi drivers are compensated for both the normal-speed trip distance and the time spent in slow-traffice. According to the fare calculation algorithm, in moving traffic on Manhattan streets, the meter should “click” approximately every four downtown blocks, or one block going cross-town (East-West); in slow traffic, the meter should "click" every 60 seconds. Therefore, slow traffic increase the minute per mile ratio. 

New York City has the worst traffic jam, and it has overtaken Miami to be voted the U.S. city with the angriest and most aggressive drivers in 2009, according to a survey on road rage released on Tuesday. Bad traffic also cause slow-traffic, and taxi drivers tend to suck in traffic during rush hours.[@reaney2009] Does minute per mile ratio have an impact on the percent tip that passengers pay? Do passengers compensate taxi drivers more during rush hours? Are passengers sympathetic to taxi drivers for the time they spend in slow traffic?

```{r, message=FALSE, echo=FALSE}
yellow_2017_summary_small <- yellow_2017_summary %>%
  mutate(min_per_mile = avg_duration/avg_dis) %>%
  filter(trips > 30)

min_mile_ratio <- lm(avg_tip ~ min_per_mile, data = yellow_2017_summary_small)
summary(min_mile_ratio)$coef[1:2,]
```
As shown in the regression result, fare per minute ratio has a significant positive impact on percent tip. `min_per_mile` ratio does have an positive impact on percent tips. Since trips with slow traffice can be depicted by high minute per mile ratio, passengers do pay more tips during rush hours. 


<!--chapter:end:03-chap3.Rmd-->

```{r, message=FALSE, echo=FALSE}
opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=FALSE)
```

# New York City Taxi Passengers {#chapter4}

## How long does it take to get to JFK, La Guardia, and Newark Airports? When is the best time to depart?

We want to calculate the average number of minutes it takes to go to all three airport from a specific taxi zone at every hour. First, we want to focus on trips going to any of the three airports, JFK, LaGuardia, or Newark Airport. We need to load trip records with destination as one of the three airports from the MySQL connection we built.

```{r, message=FALSE, echo=FALSE, eval=FALSE}
db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)
```

```{r, message=FALSE, eval=FALSE}
to_jfk_trip <- taxi %>%
  tbl("yellow") %>%
  filter(DOLocationID == 132) %>%
  collect(n = Inf)

to_lg_trip <- taxi %>%
  tbl("yellow") %>%
  filter(DOLocationID == 138) %>%
  collect(n = Inf)

to_newark_trip <- taxi %>%
  tbl("yellow") %>%
  filter(DOLocationID == 1) %>%
  collect(n = Inf)
```

Now we want to calculate the average amount of time it take from each zone to one of the three airports during each hour.
```{r, echo=FALSE, eval=FALSE}
to_jfk_zone <- to_jfk_trip %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(min = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2),
         hour = hour(tpep_pickup_datetime)) %>%
  mutate(min = as.numeric(min),
         min_dis = min/trip_distance) %>%
  filter(PULocationID != DOLocationID) %>%
  filter(min > 3) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 1) %>%
  filter(payment_type < 3) %>%
  filter(PULocationID <264) %>%
  filter(1 < min_dis) %>% 
  filter(min_dis < 30) %>%
  group_by(PULocationID, hour) %>%
  summarise(avg_min = mean(min)) %>%
  arrange(PULocationID)

to_lg_zone <- to_lg_trip %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(min = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2),
         hour = hour(tpep_pickup_datetime)) %>%
  mutate(min = as.numeric(min),
         min_dis = min/trip_distance) %>%
  filter(PULocationID != DOLocationID) %>%
  filter(min > 3) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 1) %>%
  filter(payment_type < 3) %>%
  filter(PULocationID <264) %>%
  filter(1 < min_dis) %>% 
  filter(min_dis < 30) %>%
  group_by(PULocationID, hour) %>%
  summarise(avg_min = mean(min)) %>%
  arrange(PULocationID)

to_newark_zone <- to_newark_trip %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(min = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2),
         hour = hour(tpep_pickup_datetime)) %>%
  mutate(min = as.numeric(min),
         min_dis = min/trip_distance) %>%
  filter(PULocationID != DOLocationID) %>%
  filter(min > 3) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 1) %>%
  filter(payment_type < 3) %>%
  filter(PULocationID <264) %>%
  filter(1 < min_dis) %>% 
  filter(min_dis < 30) %>%
  group_by(PULocationID, hour) %>%
  summarise(avg_min = mean(min)) %>%
  arrange(PULocationID)
```

```{r, echo=FALSE, eval=FALSE, message=FALSE}
fwrite(to_jfk_zone, "/Users/priscilla/Desktop/Honors Thesis/data/to_jfk_zone.csv")
fwrite(to_lg_zone, "/Users/priscilla/Desktop/Honors Thesis/data/to_lg_zone.csv")
fwrite(to_newark_zone, "/Users/priscilla/Desktop/Honors Thesis/data/to_newark_zone.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(data.table)
to_jfk_zone <- fread("/Users/priscilla/Desktop/Honors Thesis/data/to_jfk_zone.csv")
to_lg_zone <- fread("/Users/priscilla/Desktop/Honors Thesis/data/to_lg_zone.csv")
to_newark_zone <- fread("/Users/priscilla/Desktop/Honors Thesis/data/to_newark_zone.csv")
```

So far, we have created three tables summarsing the average number of minutes it takes to go to all three airports for every hour from different taxi zones. 

It would be easier if we combine all three tables and put information related to trip duration to all three airports in the same table.
```{r, echo=FALSE}
to_jfk_zone <- to_jfk_zone %>%
  mutate(airport = "JFK") %>%
  rename(avg_min = jfk_avg_min)

to_lg_zone <- to_lg_zone %>%
  mutate(airport = "LG") %>%
  rename(avg_min = jfk_avg_min)

to_newark_zone <- to_newark_zone %>%
  mutate(airport = "Newark") %>%
  rename(avg_min = jfk_avg_min)

three_air <- bind_rows(to_jfk_zone, to_lg_zone, to_newark_zone)
```

```{r, message=FALSE, echo=FALSE}
kable(three_air[10:20,], caption = "Average number of minutes it takes from Alphabet City, Manhattan to JFK Airport during different hours")
```
Table \@ref(tab:three_air) displays the average number of minutes it takes from Alphabet City, Manhattan to JFK Airport during different hours.

### Case Study: From Alphabet City, Manhattan to all three airport
Alphabet City, Manhattan has pick-up zone ID number 4. Let's take a look at how much time is needed to travel to all three airports from taxi zone No.4.
```{r}
alphabet <- three_air%>%
  filter(PULocationID ==4)
```

```{r airport-vis, message=FALSE, echo=FALSE, fig.cap="Average number of minutes it takes from Alphabet City, Manhattan to all three airports during different hours"}
airport_vis <- ggplot(data = alphabet, 
                     aes(x = hour, y = avg_min, colour = airport)) +
  geom_line(aes(group = airport)) + geom_point() +
  xlab("Hour of Departure") +
  ylab("Average Number of Minutes") +
  scale_x_continuous(limits = c(0, 23))
airport_vis
```

According to the red line Figure \@ref(fig:airport-vis), it takes the least time, less than 30 minutes, to travel from Alphabet City, Manhattan to JFK Airport around 4 AM in the morning, and it takes the most time, about 70 minutes, around 4 PM in the afternoon.

According to the green line, it takes the least time, about 20 minutes, to travel to JFK Airport around 5 AM in the morning, and it takes the most time, more than 40 minutes, around 5 PM in the afternoon.

As shown by the blue line, it takes the least time, a little less than 30 minutes, to travel to Newark Airport at 2 AM at midnight, and it takes the most time, a little less than 80 minutes, around 6 PM in the evening.

### A Shiny App: allowing users to choose a pick up zone of their interest, and output the best time to travel from that zone to all three airports in New York

```{r, echo=FALSE, eval=FALSE}
library(shiny)
library(rsconnect)

list_of_zones <- taxi_zone_lookup$Zone

three_air_zone <- three_air %>%
  rename(LocationID = PULocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(PULocationID = LocationID)

ui <- fluidPage(
  titlePanel(title=h4("Number of Minutes", align="center")), 
  selectInput("taxizone", "Taxi Pick-Up Zone:", list_of_zones),
  mainPanel(plotOutput("plot2")) )

server <- function(input,output) {
  dat <- reactive({
    test <- three_air_zone %>% dplyr::filter(Zone == input$taxizone)
    print(test)
    test
  })
  
  output$plot2 <- renderPlot({
    p1 <- ggplot(dat(), 
                     aes(x = hour, y = avg_min, colour = airport)) +
      geom_line(aes(group = airport)) + geom_point() +
      xlab("Hour of Departure") +
      ylab("Average Number of Minutes") +
      scale_x_continuous(limits = c(0, 23))
    p1
    })
}

shinyApp(ui, server)
```

```{r shinyapp, fig.caption = "Shiny App: Average Number of Minutes Takes to Go to All Three Airports",fig.align='center', echo=FALSE}
knitr::include_graphics("figure/shinyapp.png", dpi = 200 )
```
This Shiny App helps passengers to estimate the amount of time that is needed for them to travel to any one of the these three airports from any New York City taxi zones.

## How does weather affect the number of taxi and Lyft trips?
On a snowy or rainy day, it is hard for passengers to find a yellow cab on the street. Taxi drivers get paid at the same rate no matter how bad the weather gets, so they tend to stay at home instead of going out to work when the weather is bad. Uber drivers, however, get paid more on a snowy or rainy day, since Uber uses a pricing model that takes the number of Uber vehicles available on the street into account. When weather is bad, less Uber vehicles are available on the street, so Uber fare rate increases. Uber's pricing model gives Uber drivers an incentive to keep working on ugly days. Lyft has a similar pricing model to the one that Uber uses.

In this section, we want to study the number of pickups of yellow cab, Uber, and Lyft. We compare number of pick-ups in each taxi zone in the weeks of bad weather with previous weeks' total number of pick-ups to see whether Uber drivers have an incentive to drive around the city more when weather gets bad.

**Uber Weekly Data**
```{r, eval=FALSE, echo=FALSE}
download.file("https://data.cityofnewyork.us/resource/gt3n-7ri6.csv?years=2017&$limit=50000", destfile = "/Users/priscilla/Desktop/Honors Thesis/data/uber_weekly_data.csv")
```

```{r, echo=FALSE, message=FALSE}
uber_weekly_data <- fread("/Users/priscilla/Desktop/Honors Thesis/data/uber_weekly_data.csv")

uber_weekly <- uber_weekly_data %>%
  group_by(`Pickup Start Date`, `Pickup End Date`) %>%
  summarise(`Total Dispatched Trips` = sum(`Total Dispatched Trips`))
```

```{r, message=FALSE, echo=FALSE}
kable(uber_weekly[1:10,], caption = "Uber 2017 Weekly Total Dispatched Trips")
```

**Yellow Cab Weekly Data**
```{r, eval=FALSE, echo=FALSE}
db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)

yellow_date <- taxi %>%
  tbl("yellow") %>%
  select(tpep_dropoff_datetime, tpep_pickup_datetime) %>%
  collect(n = Inf)

yellow_weekly <- yellow_weekly %>%
  mutate(`Pickup Start Date` = floor_date(tpep_pickup_datetime, unit = "week")) %>%
  group_by(`Pickup Start Date`) %>%
  summarise(`Total Dispatched Trips` = n()) %>%
  mutate(`Pickup Start Date` = ymd(`Pickup Start Date`))

fwrite(yellow_weekly, "/Users/priscilla/Desktop/Honors Thesis/data/yellow_weekly_data.csv")
```

```{r, echo=FALSE,message=FALSE}
yellow_weekly_data <- fread("/Users/priscilla/Desktop/Honors Thesis/data/yellow_weekly_data.csv")
```

```{r, message=FALSE, echo=FALSE}
kable(yellow_weekly_data[1:10,], caption = "Yellow Taxi 2017 Weekly Total Dispatched Trips")
```

In this section, we use New York City Yellow Taxi and Uber data to calculate the number of trips occurred in each week. 

### Case Study: March 14th, 2017 Snow Storm
There are two commonly known bad weather consitions, rainy and snowy day. Let's first focus on snowstorm. I downloaded daily Central Park weather data from the National Climatic Data Center, and joined it to the taxi data to see if we could learn anything else about the relationship between weather and taxi rides. 

On March 14th, 2017, a snow storm brought seven inches of snow to New York City.
**Yellow Taxi**
```{r, echo=FALSE}
yellow_weekly_data %>%
  filter(`Pickup Start Date` == "2017-03-12" | `Pickup Start Date` == "2017-03-05")
```

```{r}
(2066285-2456285)/2456285
```

**Uber**
```{r, echo=FALSE}
uber_weekly %>%
  filter(`Pickup Start Date` == "03/12/2017" | `Pickup Start Date` == "03/05/2017")
```
```{r}
(3430189-3614559)/3614559
```
In this case, we observe that the percent decline in Uber's total number of pick-ups is 10% less than the percent decline in Yellow Taxi's total number of dropp-off. Even though the total number of Uber pick-ups did not increase, Uber's pricing model definitely was able to keep more drivers in the market on a snowy day.

**More analysis is needed here**

<!--chapter:end:04-chap4.Rmd-->

```{r, message=FALSE, echo=FALSE}
opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=FALSE)
```

# New York City Taxi Fare & Limousine Commission {#chapter5}

## Should there be a flat rate between Manhattan and John F. Kennedy International Airport?
Why is there a flat rate to and from JFK airport and any location in Manhattan? Why is the flat rate \$52? Does TLC make profit from the \$52 flat rate? Does \$52 reduce the cogestion on the road to JFK airport and make taking a train a more preferable choice? The New York City taxi trip records can reveal the answers to these questions.

Imagine it's your first time travelling to New York City, and you decided to live in a hotel in Manhattan Since you do not know much about the city, the \$52 flat rate is nice for you, and it incentivizes you to take taxi to the JFK Airport. If there is no flat rate, there is uncertainty in how much someone needs to pay to take a taxi to JFK, and tourists might instead choose to take the train, even though taking a train would cost them more time and inconvenience. 

Additionally, people who are native to Manhattan would have paid more than $52 to take a taxi to go to the JFK Airport. The higher the taxi fare is, the less the demand for taxi will be. Therefore, having a flat rate,helps taxi drivers to get more trips from Manhattan to JFK Airport.

### People in Manhattan benefit from the $52 flat rate.
If there is no flat rate between JFK and Manhattan, how much would passengers pay for the distance they travelled between JFK Airport AND Manhattan? And how much more or less should they have paid comparing to the \$52 flat rate?

```{r, echo=FALSE, message=FALSE, warning=FALSE}
db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)
```

In this study, we are only interested in yellow taxi trip between Manhattan and JFK Airport.
```{r, message=FALSE, eval=FALSE}
to_jkf <- taxi %>%
  tbl("yellow") %>%
  filter(DOLocationID == 132) %>%
  collect(n = Inf)

from_jfk <- taxi %>%
  tbl("yellow") %>%
  filter(PULocationID == 132) %>%
  collect(n = Inf)
```

```{r, message=FALSE, eval=FALSE, echo=FALSE}
fwrite(to_jkf, "/Users/priscilla/Desktop/Honors Thesis/mysql/csv sum/to_jkf.csv")
fwrite(from_jfk, "/Users/priscilla/Desktop/Honors Thesis/mysql/csv sum/from_jfk.csv")
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
library(lubridate)
to_jfk_1 <- fread("/Users/priscilla/Desktop/Honors Thesis/mysql/csv sum/to_jkf.csv")
from_jfk_1 <- fread("/Users/priscilla/Desktop/Honors Thesis/mysql/csv sum/from_jfk.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
to_jfk <- to_jfk_1 %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(min = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2),
         hour = hour(tpep_pickup_datetime)) %>%
  mutate(min = as.numeric(min),
         min_dis = min/trip_distance) %>%
  filter(PULocationID != DOLocationID) %>%
  filter(min > 3) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 1) %>%
  filter(payment_type < 3) %>%
  filter(PULocationID <264) %>%
  filter(1 < min_dis) %>% 
  filter(min_dis < 30) %>%
  filter(PULocationID <= 263)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
from_jfk <- from_jfk_1 %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(min = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2),
         hour = hour(tpep_pickup_datetime)) %>%
  mutate(min = as.numeric(min),
         min_dis = min/trip_distance) %>%
  filter(PULocationID != DOLocationID) %>%
  filter(min > 3) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 1) %>%
  filter(payment_type < 3) %>%
  filter(PULocationID <264) %>%
  filter(1 < min_dis) %>% 
  filter(min_dis < 30) %>%
  filter(DOLocationID <= 263)
```

#### Trips from Manhattan to JFK Airport
We first focus on all the trips that departed in Manhattan and went to JFK Airport, and then we calculate the estmated fare amount that the passengers should have paid based on the distance travelled from each pick-up point to JFK Airport based on the fare rate suggested by TLC for each pick-up zone. 

```{r, message=FALSE, echo=FALSE}
data("taxi_zone_lookup")
data(taxi_zones)
to_jfk <- to_jfk %>%
  filter(DOLocationID == 132) %>%
  mutate(est_fare = 2.5 + 0.5 * trip_distance * 5 + extra + improvement_surcharge + mta_tax + tolls_amount) %>%
  mutate(est_diff = est_fare - fare_amount) %>%
  rename(LocationID = PULocationID) %>%
  left_join(taxi_zone_lookup , by = "LocationID") %>%
  filter(Borough == "Manhattan")

to_jkf_zone <- to_jfk %>%
  group_by(LocationID) %>%
  summarise(num_trips = n(), 
            avg_est_fare = mean(est_fare),
            avg_est_diff = mean(est_diff)) %>%
  left_join(taxi_zone_lookup , by = "LocationID")
```

Here is a map of estmated fare amount calculated by taking the average of all estimated fare amounts from the same pick-up zone to JFK Airport based on the fare rate suggested by TLC for each pick-up zone. 
```{r, echo=FALSE, eval=FALSE}
to_jkf_fare <- merge(taxi_zones, to_jkf_zone, by.x = "LocationID", by.y = "LocationID")

to_jkf_fare_vis <- leaflet(data = to_jkf_fare) %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addPolygons(fillColor = ~reds(avg_est_fare),
              fillOpacity = 0.6,
              weight = 1,
              opacity = 0.8) %>%
  setView(lat = 40.78, lng = -74.0060, zoom = 12)

saveWidget(to_jkf_fare_vis, file = "/Users/priscilla/Desktop/Honors Thesis/figure/to_jkf_fare_vis.html")
URL <- "/Users/priscilla/Desktop/Honors Thesis/figure/to_jkf_fare_vis.html"
webshot(URL, "figure/to_jkf_fare_vis.png", cliprect = "viewport")
```

```{r to-jkf-fare-vis, fig.cap="Estmated fare amount from the each pick-up zone to JFK Airport", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/to_jkf_fare_vis.png", dpi = 200 )
```
According to the map, trips from Midtown on average cost less than trips from other taxi zones in Manhattan.

### Taxi zones pays on average more than $52
We computed the average fare paid by passengers for trips going from each taxi zone in Manhattan to JFK Airport:

```{r, echo=FALSE}
to_jkf_zone_above <- to_jkf_zone %>%
  filter(avg_est_fare > 52) %>%
  arrange(desc(avg_est_fare))

to_jkf_zone_above_1 <- to_jkf_zone_above %>%
  filter(num_trips > 10)
```

```{r to_jkf_zone_above, fig.cap = "Ten pick-up zones with the highest avergae fare from Manhattan to JKF Airport"}
kable(to_jkf_zone_above[1:10, 2:6])
```

Let's visualize the taxi zones that would have costed more than the \$52 flat rate.

```{r, echo=FALSE, eval=FALSE}
to_jkf_fare_above <- merge(taxi_zones, to_jkf_zone_above, by.x = "LocationID", by.y = "LocationID")

to_jfk_fare_above_vis <- leaflet(data = to_jkf_fare_above) %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addPolygons(fillColor = ~reds(avg_est_fare),
              fillOpacity = 0.6,
              weight = 1,
              opacity = 0.8) %>%
  setView(lat = 40.7831, lng = -73.9712, zoom = 12)

saveWidget(to_jfk_fare_above_vis, file = "/Users/priscilla/Desktop/Honors Thesis/writing/figures/to_jfk_fare_above_vis.html")
URL <- "/Users/priscilla/Desktop/Honors Thesis/writing/figures/to_jfk_fare_above_vis.html"
webshot(URL, "figure/to_jfk_fare_above_vis.png", cliprect = "viewport")
#add t test to test average fare vs 52
```

```{r above52, fig.cap= "Zones that cost more than the $52 flat rate", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/to_jfk_fare_above_vis.png", dpi = 200 )
```

Therefore, passengers from places in Manhattan besides Midtown, East Village, and some parts of Lower Manhattan benefit from the $52 flat rate. However, people living in Midtown, East Village, and some parts of Lower Manhattan might be relatively more indifferent to the price of taxi. Instead, they probably put more emphasis on convenience and time.

```{r}
mean(to_jkf_zone$avg_est_diff)
meanfare <- mean(to_jkf_zone$avg_est_diff)
```
On average people travel from Manhattan pay `meanfare` less with the \$52 flat rate policy. Therefore, passengers overall benefit from the $52 flat rate policy.

## However, are taxi drivers happy when their passengers are going to JFK Airport from Manhattan?
Everytime I travel to New York City, I always take Yellow cabs to go around the city. It seemed to me that the cab drivers were always happy whenever they heard me telling them that I need to go to the JFK Airport from Manhattan. Are taxi drivers happy when their passengers are going to JFK Airport from Manhattan? How much on average would taxi driver make on their way bavk to the city from Manhattan? 

```{r, echo=FALSE}
from_jfk <- from_jfk %>%
  mutate(est_fare = 2.5 + 0.5 * trip_distance * 5 + extra + improvement_surcharge + mta_tax + tolls_amount) %>%
  mutate(est_diff = est_fare - fare_amount) %>%
  rename(LocationID = DOLocationID) %>%
  left_join(taxi_zone_lookup , by = "LocationID")
```

Since a taxi driver coming from Manhattan to JFK Airport could be directed back to anywhere in the city. We can calculate the average taxi fare amount that the taxi drivers would get paid for a random trip from JFK Airport to any part of the city.

```{r, message=FALSE, warning=FALSE}
mean(from_jfk$est_fare)
```
On average, taxi drivers would get paid for \$50.18 for a trip from the JFK Airport to any taxi zone in New York City. What are the most popular drop-off zones for yellow taxis from JFK Airport?
```{r, echo=FALSE, message=FALSE}
from_jkf_zone <- from_jfk %>%
  group_by(LocationID) %>%
  summarise(num_trips = n(), 
            avg_fare = mean(fare_amount),
            avg_est_fare = mean(est_fare),
            avg_est_diff = mean(est_diff)) %>%
  left_join(taxi_zone_lookup , by = "LocationID") %>%
  arrange(desc(num_trips))
```

```{r, message=FALSE, echo=FALSE}
kable(from_jkf_zone[,3:7], caption = "Ten most popular destinations in Manhattan")
```
Table \@ref(tab:from_jkf_zone) shows that Times Square is the most popular destination for passengers coming from the JFK Airport in 2017!

**What's the average fare to each dropp-off zone from JFK Airport? **

```{r, eval=FALSE, echo=FALSE}
from_jkf_fare <- merge(taxi_zones, from_jkf_zone, by.x = "LocationID", by.y = "LocationID")

from_jkf_fare_vis <- leaflet(data = from_jkf_fare) %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addPolygons(fillColor = ~reds(avg_fare),
              fillOpacity = 0.6,
              weight = 1,
              opacity = 0.8) %>%
  setView(lat = 40.7128, lng = -74.0060, zoom = 11)

saveWidget(from_jkf_fare_vis, file = "/Users/priscilla/Desktop/Honors Thesis/writing/figures/from_jkf_fare_vis.html")
URL <- "/Users/priscilla/Desktop/Honors Thesis/writing/figures/from_jkf_fare_vis.html"
webshot(URL, "figure/from_jkf_fare_vis.png", cliprect = "viewport")

from_jkf_fare_est <- leaflet(data = from_jkf_fare) %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addPolygons(fillColor = ~reds(avg_est_fare),
              fillOpacity = 0.6,
              weight = 1,
              opacity = 0.8) %>%
  setView(lat = 40.7128, lng = -74.0060, zoom = 11)

saveWidget(from_jkf_fare_est, file = "/Users/priscilla/Desktop/Honors Thesis/writing/figures/from_jkf_fare_est.html")
URL <- "/Users/priscilla/Desktop/Honors Thesis/writing/figures/from_jkf_fare_est.html"
webshot(URL, "figure/from_jkf_fare_est.png", cliprect = "viewport")
```

```{r from-jkf-fare-vis, fig.cap="Zones that cost more than the $52 flat rate", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/from_jkf_fare_vis.png", dpi = 200 )
```

As we expected, the red shades are smoothly distributed, since taxi zones that are futher away should cost more to get there.

By comparing the distribution of the true average fare and estimated average fare calculated by distance travelled, 

****** add sentences *******

```{r from-jkf-fare-est, fig.cap="Zones that cost more than the $52 flat rate", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/from_jkf_fare_est.png", dpi = 200 )
```

**What's the most popular dropp-off locations for passengers from JFK Airport? **

```{r, eval=FALSE, echo=FALSE}
from_jkf_num_trips <- leaflet(data = from_jkf_fare) %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addPolygons(fillColor = ~reds(num_trips),
              fillOpacity = 0.6,
              weight = 1,
              opacity = 0.8) %>%
  setView(lat = 40.7128, lng = -74.0060, zoom = 11)

saveWidget(from_jkf_num_trips, file = "/Users/priscilla/Desktop/Honors Thesis/writing/figures/from_jkf_num_trips.html")
URL <- "/Users/priscilla/Desktop/Honors Thesis/writing/figures/from_jkf_num_trips.html"
webshot(URL, "figure/from_jkf_num_trips.png", cliprect = "viewport")
```

```{r from-jkf-num-trips, fig.cap="Zones that cost more than the $52 flat rate", fig.align='center', echo=FALSE}
knitr::include_graphics("figure/from_jkf_num_trips.png", dpi = 200 )
```

According to the map above, Manhattan is still the most popular destination for passengers departing from the JFK Airport. 

```{r, echo=FALSE}
from_jkf_zone %>%
  mutate(Manhattan = ifelse(Borough == "Manhattan", 1, 0)) %>%
  group_by(Manhattan) %>%
  summarise(all_trips = sum(num_trips))
```
```{r}
from_jkf_zone[2,2]/(from_jkf_zone[1,2] + from_jkf_zone[2,2])
```
According to the summary, the total amount of trips from JFK Airport to Manhattan is about 65.05% of the total number of trips travelling from JFK Airport to all other Borough. Therefore, it is very likely for taxi drivers to get passengers who want to go to Manhattan with a flat rate of \$52. In this case, a round trip to and from JFK Airport is worthy. Therefore, taxi drivers should be pretty happy when their passengers are going to JFK Airport from Manhattan. 


<!--chapter:end:05-chap5.Rmd-->

# Conclusion {#chapter5}


## Future Research

For future study, I would love to investigate the sharp decline in the consumption of NYC yellow cab after e-hail services were introduced into the NYC ride-hail market. I also want to study what the impact of introducing new GPS and entertainment system is on the number of rides. The global product and marketing at Verifone, Jason Gross, said that, “I like to say that we provide what Uber says it provides.” With the raised expectation among rides caused by Uber and Lyft, yellow taxi industry need to respond quickly. How does the market react to the newly installed entertainment system? Has the market share of yellow cab rebounded since 2016? By looking into the patterns in market shares, it might be possible for me to predict the future market share distribution and find out what features of ride-hail transportation are the ones that affect market share distribution the most. 


<!--chapter:end:06-conclusion.Rmd-->

`r if(knitr:::is_latex_output()) '\\appendix'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'` 

<!--
If you feel it necessary to include an appendix, it goes here.
-->

# Appendix A

## utility function

This utility function was written to shortened the source code in ETL `etl_extract.etl_nyctaxi()` function.

```{r, eval=FALSE}
download_nyc_data <- function(obj, url, years, n, names, ...) {
  url <- paste0(url, "?years=", years, "&$limit=", n)
  lcl <- file.path(attr(obj, "raw"), names)
  downloader::download(url, destfile = lcl, ...)
  lcl
}
```

<!--chapter:end:07-appendix.Rmd-->

<!--
The bib chunk below must go last in this document according to how R Markdown renders.  More info is at http://rmarkdown.rstudio.com/authoring_bibliographies_and_citations.html
-->

\backmatter

<!-- 
If you'd like to change the name of the bibliography to something else,
delete "References" and replace it.
-->

# References {-}
<!--
This manually sets the header for this unnumbered chapter.
-->
\markboth{References}{References}
<!--
To remove the indentation of the first entry.
-->
\noindent

<!--
To create a hanging indent and spacing between entries.  These three lines may need to be removed for styles that don't require the hanging indent.
-->

\setlength{\parindent}{-0.20in}
\setlength{\leftskip}{0.20in}
\setlength{\parskip}{8pt}


<!--
This is just for testing with more citations for the bibliography at the end.  Add other entries into the list here if you'd like them to appear in the bibliography even if they weren't explicitly cited in the document.
-->

---
nocite: | 
  @angel2000, @angel2001, @angel2002a
...

<!--chapter:end:99-references.Rmd-->

