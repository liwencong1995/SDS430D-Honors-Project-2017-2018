```{r, message=FALSE, echo=FALSE}
opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=FALSE)
```

# New York City Taxi Passengers {#chapter4}

## How long does it take to get to JFK, La Guardia, and Newark Airports? When is the best time to depart?
We want to calculate the average number of minutes it takes to go to all three airport from a specific taxi zone at every hour. First, we want to focus on trips going to any of the three airports, JFK, LaGuardia, or Newark Airport. We need to load trip records with destination as one of the three airports from the MySQL connection we built.

```{r, message=FALSE, echo=FALSE, eval=FALSE}
db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)
```

```{r, message=FALSE, eval=FALSE}
to_jfk_trip <- taxi %>%
  tbl("yellow") %>%
  filter(DOLocationID == 132) %>%
  collect(n = Inf)

to_lg_trip <- taxi %>%
  tbl("yellow") %>%
  filter(DOLocationID == 138) %>%
  collect(n = Inf)

to_newark_trip <- taxi %>%
  tbl("yellow") %>%
  filter(DOLocationID == 1) %>%
  collect(n = Inf)
```

Now we want to calculate the average amount of time it take from each zone to one of the three airports during each hour.
```{r, echo=FALSE, eval=FALSE}
to_jfk_zone <- to_jfk_trip %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(min = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2),
         hour = hour(tpep_pickup_datetime)) %>%
  mutate(min = as.numeric(min),
         min_dis = min/trip_distance) %>%
  filter(PULocationID != DOLocationID) %>%
  filter(min > 3) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 1) %>%
  filter(payment_type < 3) %>%
  filter(PULocationID <264) %>%
  filter(1 < min_dis) %>% 
  filter(min_dis < 30) %>%
  group_by(PULocationID, hour) %>%
  summarise(avg_min = mean(min)) %>%
  arrange(PULocationID)

to_lg_zone <- to_lg_trip %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(min = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2),
         hour = hour(tpep_pickup_datetime)) %>%
  mutate(min = as.numeric(min),
         min_dis = min/trip_distance) %>%
  filter(PULocationID != DOLocationID) %>%
  filter(min > 3) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 1) %>%
  filter(payment_type < 3) %>%
  filter(PULocationID <264) %>%
  filter(1 < min_dis) %>% 
  filter(min_dis < 30) %>%
  group_by(PULocationID, hour) %>%
  summarise(avg_min = mean(min)) %>%
  arrange(PULocationID)

to_newark_zone <- to_newark_trip %>%
  mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime,  
                                         tz= "America/New_York"),
         tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime,  
                                        tz= "America/New_York")) %>%
  mutate(min = round((tpep_dropoff_datetime - tpep_pickup_datetime)/60, 2),
         hour = hour(tpep_pickup_datetime)) %>%
  mutate(min = as.numeric(min),
         min_dis = min/trip_distance) %>%
  filter(PULocationID != DOLocationID) %>%
  filter(min > 3) %>%
  filter(fare_amount > 0) %>%
  filter(tip_amount > 0) %>%
  filter(tip_amount < fare_amount) %>%
  filter(trip_distance > 1) %>%
  filter(payment_type < 3) %>%
  filter(PULocationID <264) %>%
  filter(1 < min_dis) %>% 
  filter(min_dis < 30) %>%
  group_by(PULocationID, hour) %>%
  summarise(avg_min = mean(min)) %>%
  arrange(PULocationID)
```

```{r, echo=FALSE, eval=FALSE, message=FALSE}
fwrite(to_jfk_zone, "/Users/priscilla/Desktop/Honors Thesis/data/to_jfk_zone.csv")
fwrite(to_lg_zone, "/Users/priscilla/Desktop/Honors Thesis/data/to_lg_zone.csv")
fwrite(to_newark_zone, "/Users/priscilla/Desktop/Honors Thesis/data/to_newark_zone.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(data.table)
to_jfk_zone <- fread("/Users/priscilla/Desktop/Honors Thesis/data/to_jfk_zone.csv")
to_lg_zone <- fread("/Users/priscilla/Desktop/Honors Thesis/data/to_lg_zone.csv")
to_newark_zone <- fread("/Users/priscilla/Desktop/Honors Thesis/data/to_newark_zone.csv")
```

So far, we have created three tables summarsing the average number of minutes it takes to go to all three airports for every hour from different taxi zones. It would be easier if we combine all three tables and put information related to trip duration to all three airports in the same table.
```{r, echo=FALSE}
to_jfk_zone <- to_jfk_zone %>%
  mutate(airport = "JFK") %>%
  rename(avg_min = jfk_avg_min)

to_lg_zone <- to_lg_zone %>%
  mutate(airport = "LGA") %>%
  rename(avg_min = jfk_avg_min)

to_newark_zone <- to_newark_zone %>%
  mutate(airport = "EWR") %>%
  rename(avg_min = jfk_avg_min)

three_air <- bind_rows(to_jfk_zone, to_lg_zone, to_newark_zone)
```

```{r, message=FALSE, echo=FALSE}
kable(three_air[10:20,], 
      caption = "Average number of minutes it takes from Alphabet City, Manhattan to JFK Airport during different hours",
      format = "latex",
      align = 'c', 
      escape = TRUE,
      booktabs = TRUE)
```
Table \@ref(tab:three_air) displays the average number of minutes it takes from Alphabet City, Manhattan to JFK Airport during different hours.

### Case Study: From Alphabet City, Manhattan to all three airport
Alphabet City, Manhattan has pick-up zone ID number 4. Let's take a look at how much time is needed to travel to all three airports from taxi zone No.4.
```{r}
alphabet <- three_air%>%
  filter(PULocationID ==4)
```

```{r airport-vis, message=FALSE, echo=FALSE, fig.cap="Average number of minutes it takes from Alphabet City, Manhattan to all three airports during different hours"}
airport_vis <- ggplot(data = alphabet, 
                     aes(x = hour, y = avg_min, colour = airport)) +
  geom_line(aes(group = airport)) + geom_point() +
  xlab("Hour of Departure") +
  ylab("Average Number of Minutes") +
  scale_x_continuous(limits = c(0, 23))
airport_vis
```

According to the red line Figure \@ref(fig:airport-vis), it takes the least time, less than 30 minutes, to travel from Alphabet City, Manhattan to JFK Airport around 4 AM in the morning, and it takes the most time, about 70 minutes, around 4 PM in the afternoon.

According to the green line, it takes the least time, about 20 minutes, to travel to La Guardia Airport around 5 AM in the morning, and it takes the most time, more than 40 minutes, around 5 PM in the afternoon.

As shown by the blue line, it takes the least time, a little less than 30 minutes, to travel to Newark Airport at 2 AM at midnight, and it takes the most time, a little less than 80 minutes, around 6 PM in the evening.

### A Shiny App: allowing users to choose a pick up zone of their interest, and output the best time to travel from that zone to all three airports in New York

```{r, echo=FALSE, eval=FALSE}
library(shiny)
library(rsconnect)

list_of_zones <- taxi_zone_lookup$Zone

three_air_zone <- three_air %>%
  rename(LocationID = PULocationID)%>%
  left_join(taxi_zone_lookup, by = "LocationID") %>%
  rename(PULocationID = LocationID)

ui <- fluidPage(
  titlePanel(title=h4("Number of Minutes", align="center")), 
  selectInput("taxizone", "Taxi Pick-Up Zone:", list_of_zones),
  mainPanel(plotOutput("plot2")) )

server <- function(input,output) {
  dat <- reactive({
    test <- three_air_zone %>% dplyr::filter(Zone == input$taxizone)
    print(test)
    test
  })
  
  output$plot2 <- renderPlot({
    p1 <- ggplot(dat(), 
                     aes(x = hour, y = avg_min, colour = airport)) +
      geom_line(aes(group = airport)) + geom_point() +
      xlab("Hour of Departure") +
      ylab("Average Number of Minutes") +
      scale_x_continuous(limits = c(0, 23))
    p1
    })
}

shinyApp(ui, server)
```

```{r shinyapp, fig.caption = "Shiny App: Average Number of Minutes Takes to Go to All Three Airports",fig.align='center', echo=FALSE}
knitr::include_graphics("figure/shinyapp.png", dpi = 100 )
```
This Shiny App helps passengers to estimate the amount of time that is needed for them to travel to any one of the these three airports from any New York City taxi zones.

## How does weather affect the number of taxi and Lyft trips?
On a snowy or rainy day, it is hard for passengers to find a yellow cab on the street. Taxi drivers get paid at the same rate no matter how bad the weather gets, so they tend to stay at home instead of going out to work when the weather is bad. Uber drivers, however, get paid more on a snowy or rainy day, since Uber uses a pricing model that takes the number of Uber vehicles available on the street into account. When weather is bad, fewer Uber vehicles are available on the street, so Uber fare rate increases. Uber's pricing model gives Uber drivers an incentive to keep working on ugly days. Lyft has a similar pricing model to the one that Uber uses.

In this section, we want to study the number of pickups of yellow cab, Uber, and Lyft. We compare number of pick-ups in each taxi zone in the weeks of bad weather with previous weeks' total number of pick-ups to see whether Uber drivers have an incentive to drive around the city more when weather gets bad.

**Uber Weekly Data**
```{r, eval=FALSE, echo=FALSE}
download.file("https://data.cityofnewyork.us/resource/gt3n-7ri6.csv?years=2017&$limit=50000", destfile = "/Users/priscilla/Desktop/Honors Thesis/data/uber_weekly_data.csv")
```

```{r, echo=FALSE, message=FALSE}
uber_weekly_data <- fread("/Users/priscilla/Desktop/Honors Thesis/data/uber_weekly_data.csv")

uber_weekly <- uber_weekly_data %>%
  group_by(`Pickup Start Date`, `Pickup End Date`) %>%
  summarise(`Total Dispatched Trips` = sum(`Total Dispatched Trips`))
```

```{r, message=FALSE, echo=FALSE}
kable(uber_weekly[1:10,], 
      caption = "Uber 2017 Weekly Total Dispatched Trips",
      format = "latex",
      align = 'c', 
      escape = TRUE,
      booktabs = TRUE)
```

**Yellow Cab Weekly Data**
```{r, eval=FALSE, echo=FALSE}
db <- src_mysql("nyctaxi", user = "wli37", host = "scidb.smith.edu", password = "Calculati0n")
taxi <- etl("nyctaxi", db)

yellow_date <- taxi %>%
  tbl("yellow") %>%
  select(tpep_dropoff_datetime, tpep_pickup_datetime) %>%
  collect(n = Inf)

yellow_weekly <- yellow_weekly %>%
  mutate(`Pickup Start Date` = floor_date(tpep_pickup_datetime, unit = "week")) %>%
  group_by(`Pickup Start Date`) %>%
  summarise(`Total Dispatched Trips` = n()) %>%
  mutate(`Pickup Start Date` = ymd(`Pickup Start Date`))

fwrite(yellow_weekly, "/Users/priscilla/Desktop/Honors Thesis/data/yellow_weekly_data.csv")
```

```{r, echo=FALSE,message=FALSE}
yellow_weekly_data <- fread("/Users/priscilla/Desktop/Honors Thesis/data/yellow_weekly_data.csv")
```

```{r, message=FALSE, echo=FALSE}
kable(yellow_weekly_data[1:10,], 
      caption = "Yellow Taxi 2017 Weekly Total Dispatched Trips",
      format = "latex",
      align = 'c', 
      escape = TRUE,
      booktabs = TRUE)
```

In this section, we use New York City Yellow Taxi and Uber data to calculate the number of trips occurred in each week. 

### Case Study: March 14th, 2017 Snow Storm
There are two commonly known bad weather consitions, rainy and snowy day. Let's first focus on snowstorm. I downloaded daily Central Park weather data from the National Climatic Data Center, and joined it to the taxi data to see if we could learn anything else about the relationship between weather and taxi rides. 

On March 14th, 2017, a snow storm brought seven inches of snow to New York City.
**Yellow Taxi**
```{r, echo=FALSE}
yellow_weekly_data %>%
  filter(`Pickup Start Date` == "2017-03-12" | `Pickup Start Date` == "2017-03-05")
```

```{r}
(2066285-2456285)/2456285
```

**Uber**
```{r, echo=FALSE}
uber_weekly %>%
  filter(`Pickup Start Date` == "03/12/2017" | `Pickup Start Date` == "03/05/2017")
```
```{r}
(3430189-3614559)/3614559
```
In this case, we observe that the percent decline in Uber's total number of pick-ups is 10% less than the percent decline in Yellow Taxi's total number of dropp-off. Even though the total number of Uber pick-ups did not increase, Uber's pricing model definitely was able to keep more drivers in the market on a snowy day.

**More analysis is needed here**